<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SAR Performance Diagnostic Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
    }
    h1 {
      font-size: 32px;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .subtitle {
      color: #718096;
      font-size: 14px;
      margin-bottom: 30px;
    }
    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status.running { background: #fef3c7; color: #92400e; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #e2e8f0; color: #1a202c; }
    .btn-danger { background: #ef4444; color: white; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 15px;
      padding: 20px;
      border-left: 4px solid #667eea;
      transition: all 0.3s;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .card-title {
      font-weight: 700;
      color: #1a202c;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .card-value {
      font-size: 32px;
      font-weight: 800;
      color: #667eea;
      margin-bottom: 5px;
    }
    .card-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
    }
    .test-result {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #e2e8f0;
      transition: all 0.2s;
    }
    .test-result:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .test-result.fast { border-left-color: #10b981; background: linear-gradient(90deg, #d1fae5 0%, white 100%); }
    .test-result.medium { border-left-color: #f59e0b; background: linear-gradient(90deg, #fef3c7 0%, white 100%); }
    .test-result.slow { border-left-color: #ef4444; background: linear-gradient(90deg, #fee2e2 0%, white 100%); }
    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .test-name {
      font-weight: 700;
      color: #1a202c;
      font-size: 14px;
    }
    .test-time {
      font-weight: 800;
      font-size: 18px;
    }
    .test-details {
      font-size: 12px;
      color: #64748b;
      margin-top: 5px;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      border-radius: 10px;
    }
    .recommendations {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 15px;
      padding: 20px;
      margin-top: 30px;
      border-left: 4px solid #f59e0b;
    }
    .recommendations h3 {
      color: #92400e;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .recommendation-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: #1a202c;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .recommendation-icon {
      background: #f59e0b;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      flex-shrink: 0;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .metric-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 8px;
    }
    .badge-excellent { background: #d1fae5; color: #065f46; }
    .badge-good { background: #dbeafe; color: #1e40af; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-critical { background: #fee2e2; color: #991b1b; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { transform: scale(1.1); }
    .timing-bar {
      height: 30px;
      border-radius: 8px;
      margin: 8px 0;
      display: flex;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .timing-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: 700;
      transition: all 0.3s;
      position: relative;
    }
    .timing-segment:hover {
      filter: brightness(1.2);
      z-index: 10;
    }
    .timing-segment-dns { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .timing-segment-tcp { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .timing-segment-tls { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .timing-segment-request { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .timing-segment-response { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .timing-legend {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .timing-legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    .timing-legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    .clickable-card { cursor: pointer; transition: all 0.3s; }
    .clickable-card:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      ‚ö° Performance Diagnostic Professionnel
      <span id="status" class="status running">EN ATTENTE</span>
    </h1>
    <p class="subtitle">Analyse compl√®te des performances du dashboard SAR Admin</p>

    <div class="controls">
      <button class="btn-primary" onclick="runFullDiagnostic()">
        <span>‚ñ∂Ô∏è</span> Lancer Diagnostic Complet
      </button>
      <button class="btn-secondary" onclick="runQuickTest()">
        <span>‚ö°</span> Test Rapide
      </button>
      <button class="btn-secondary" onclick="runStressTest()">
        <span>üî•</span> Stress Test
      </button>
      <button class="btn-danger" onclick="location.reload()">
        <span>üîÑ</span> R√©initialiser
      </button>
      <button class="btn-primary" onclick="downloadReport()" id="downloadBtn" style="display: none;">
        <span>üíæ</span> T√©l√©charger Rapport JSON
      </button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-title">‚ö° Temps Moyen</span>
        </div>
        <div class="card-value" id="avgTime">0ms</div>
        <div class="card-label">Temps de r√©ponse moyen des API</div>
      </div>
      <div class="card clickable-card" id="fastestCard" style="cursor: pointer;" title="Cliquez pour voir les d√©tails">
        <div class="card-header">
          <span class="card-title">üöÄ API la Plus Rapide</span>
        </div>
        <div class="card-value" id="fastest">-</div>
        <div class="card-label" id="fastestApi">En attente...</div>
        <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #64748b;">üîç Cliquez pour d√©tails</div>
      </div>
      <div class="card clickable-card" id="slowestCard" style="cursor: pointer;" title="Cliquez pour voir les d√©tails">
        <div class="card-header">
          <span class="card-title">üêå API la Plus Lente</span>
        </div>
        <div class="card-value" id="slowest">-</div>
        <div class="card-label" id="slowestApi">En attente...</div>
        <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #64748b;">üîç Cliquez pour d√©tails</div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìä Tests Effectu√©s</span>
        </div>
        <div class="card-value" id="testCount">0</div>
        <div class="card-label">Endpoints test√©s</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width: 0%"></div>
    </div>

    <h2 style="margin: 30px 0 20px 0; color: #1a202c; font-size: 20px; font-weight: 800;">
      üìã R√©sultats D√©taill√©s
    </h2>
    <div id="results"></div>

    <div id="recommendations" style="display: none;" class="recommendations">
      <h3>üí° Recommandations d'Optimisation</h3>
      <div id="recommendationsList"></div>
    </div>
  </div>

  <!-- Modal pour les d√©tails d'API -->
  <div id="apiDetailModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const endpoints = [
      { name: 'Messages', url: '/api/admin/messages/assign', critical: true },
      { name: 'VoPay Transactions', url: '/api/admin/vopay/transactions', critical: true },
      { name: 'VoPay Dashboard', url: '/api/admin/vopay', critical: true },
      { name: 'Webhook Stats', url: '/api/admin/webhooks/stats', critical: false },
      { name: 'Download Stats', url: '/api/admin/downloads/stats?fileName=test.zip', critical: false },
      { name: 'Analytics', url: '/api/admin/analytics', critical: false },
      { name: 'Support Tickets', url: '/api/admin/support/tickets?status=nouveau&limit=1', critical: false },
      { name: 'Client Analysis', url: '/api/admin/client-analysis', critical: false }
    ];

    let results = [];

    async function testEndpoint(endpoint) {
      const start = performance.now();
      const perfMark = `api-test-${Date.now()}`;
      performance.mark(perfMark);

      try {
        const response = await fetch(`${window.location.origin}${endpoint.url}`, {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        const end = performance.now();
        const time = Math.round(end - start);
        const data = await response.json();

        // Obtenir les d√©tails de timing de performance
        await new Promise(resolve => setTimeout(resolve, 10)); // Petit d√©lai pour laisser les perf entries se mettre √† jour
        const perfEntries = performance.getEntriesByType('resource');
        const resourceEntry = perfEntries.reverse().find(entry =>
          entry.name.includes(endpoint.url)
        );

        let timingDetails = null;
        if (resourceEntry) {
          timingDetails = {
            dns: Math.round(resourceEntry.domainLookupEnd - resourceEntry.domainLookupStart),
            tcp: Math.round(resourceEntry.connectEnd - resourceEntry.connectStart),
            tls: resourceEntry.secureConnectionStart > 0 ?
              Math.round(resourceEntry.connectEnd - resourceEntry.secureConnectionStart) : 0,
            request: Math.round(resourceEntry.responseStart - resourceEntry.requestStart),
            response: Math.round(resourceEntry.responseEnd - resourceEntry.responseStart),
            total: Math.round(resourceEntry.duration),
            transferSize: resourceEntry.transferSize || 0,
            encodedBodySize: resourceEntry.encodedBodySize || 0,
            decodedBodySize: resourceEntry.decodedBodySize || 0
          };
        }

        return {
          name: endpoint.name,
          url: endpoint.url,
          time: time,
          status: response.status,
          success: response.ok,
          size: new Blob([JSON.stringify(data)]).size,
          critical: endpoint.critical,
          data: data,
          timing: timingDetails
        };
      } catch (error) {
        const end = performance.now();
        return {
          name: endpoint.name,
          url: endpoint.url,
          time: Math.round(end - start),
          status: 0,
          success: false,
          error: error.message,
          critical: endpoint.critical,
          timing: null
        };
      }
    }

    function getPerformanceClass(time, critical) {
      if (critical) {
        if (time < 100) return 'fast';
        if (time < 300) return 'medium';
        return 'slow';
      } else {
        if (time < 200) return 'fast';
        if (time < 500) return 'medium';
        return 'slow';
      }
    }

    function getPerformanceBadge(time, critical) {
      if (critical) {
        if (time < 100) return '<span class="metric-badge badge-excellent">EXCELLENT</span>';
        if (time < 300) return '<span class="metric-badge badge-good">BON</span>';
        if (time < 500) return '<span class="metric-badge badge-warning">LENT</span>';
        return '<span class="metric-badge badge-critical">CRITIQUE</span>';
      } else {
        if (time < 200) return '<span class="metric-badge badge-excellent">EXCELLENT</span>';
        if (time < 500) return '<span class="metric-badge badge-good">BON</span>';
        if (time < 1000) return '<span class="metric-badge badge-warning">LENT</span>';
        return '<span class="metric-badge badge-critical">CRITIQUE</span>';
      }
    }

    function displayResult(result) {
      const perfClass = getPerformanceClass(result.time, result.critical);
      const badge = getPerformanceBadge(result.time, result.critical);
      const resultsDiv = document.getElementById('results');

      const resultHtml = `
        <div class="test-result ${perfClass}" style="cursor: pointer; transition: all 0.2s;" onclick="showApiDetails('${result.name}')" title="Cliquez pour voir les d√©tails">
          <div class="test-header">
            <div>
              <span class="test-name">${result.critical ? 'üî¥ ' : ''}${result.name}</span>
              ${badge}
              <span style="font-size: 11px; color: #64748b; margin-left: 8px;">üîç Cliquez pour d√©tails</span>
            </div>
            <span class="test-time" style="color: ${perfClass === 'fast' ? '#10b981' : perfClass === 'medium' ? '#f59e0b' : '#ef4444'}">
              ${result.time}ms
            </span>
          </div>
          <div class="test-details">
            üìç ${result.url}<br>
            ${result.success
              ? `‚úÖ Status ${result.status} ‚Ä¢ ${(result.size / 1024).toFixed(2)} KB transf√©r√©s`
              : `‚ùå Erreur: ${result.error || 'Request failed'}`
            }
          </div>
        </div>
      `;

      resultsDiv.innerHTML += resultHtml;
    }

    function updateStats() {
      const times = results.map(r => r.time);
      const avgTime = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
      const fastest = results.reduce((min, r) => r.time < min.time ? r : min, results[0]);
      const slowest = results.reduce((max, r) => r.time > max.time ? r : max, results[0]);

      document.getElementById('avgTime').textContent = avgTime + 'ms';
      document.getElementById('fastest').textContent = fastest.time + 'ms';
      document.getElementById('fastestApi').textContent = fastest.name;
      document.getElementById('slowest').textContent = slowest.time + 'ms';
      document.getElementById('slowestApi').textContent = slowest.name;
      document.getElementById('testCount').textContent = results.length;

      // Rendre les cartes cliquables
      document.getElementById('fastestCard').onclick = () => showApiDetails(fastest.name);
      document.getElementById('slowestCard').onclick = () => showApiDetails(slowest.name);
    }

    function generateRecommendations() {
      const recommendations = [];
      const criticalSlow = results.filter(r => r.critical && r.time > 300);
      const nonCriticalSlow = results.filter(r => !r.critical && r.time > 500);
      const failed = results.filter(r => !r.success);
      const largeSizes = results.filter(r => r.size > 100000); // > 100KB

      if (criticalSlow.length > 0) {
        recommendations.push(`‚ö†Ô∏è <strong>${criticalSlow.length} API(s) critique(s) trop lente(s)</strong>: ${criticalSlow.map(r => r.name).join(', ')} prennent plus de 300ms. Optimisation URGENTE requise!`);
      }

      if (nonCriticalSlow.length > 0) {
        recommendations.push(`üìä ${nonCriticalSlow.length} API(s) non-critique(s) lente(s): Envisager mise en cache ou chargement diff√©r√©`);
      }

      if (failed.length > 0) {
        recommendations.push(`‚ùå ${failed.length} API(s) en √©chec: ${failed.map(r => r.name).join(', ')} - V√©rifier l'authentification et la disponibilit√©`);
      }

      if (largeSizes.length > 0) {
        recommendations.push(`üì¶ Donn√©es volumineuses d√©tect√©es (${largeSizes.map(r => `${r.name}: ${(r.size/1024).toFixed(0)}KB`).join(', ')}) - Envisager pagination`);
      }

      const avgTime = results.reduce((a, b) => a + b.time, 0) / results.length;
      if (avgTime > 500) {
        recommendations.push(`üêå Temps moyen global √©lev√© (${Math.round(avgTime)}ms) - Probl√®me de r√©seau ou serveur surcharg√©?`);
      }

      if (recommendations.length === 0) {
        recommendations.push(`‚úÖ <strong>Performances excellentes!</strong> Toutes les API r√©pondent rapidement.`);
      }

      const recDiv = document.getElementById('recommendationsList');
      recDiv.innerHTML = recommendations.map((rec, i) => `
        <div class="recommendation-item">
          <span class="recommendation-icon">${i + 1}</span>
          <div>${rec}</div>
        </div>
      `).join('');

      document.getElementById('recommendations').style.display = 'block';
    }

    async function runFullDiagnostic() {
      document.getElementById('status').textContent = 'EN COURS';
      document.getElementById('status').className = 'status running';
      document.getElementById('results').innerHTML = '';
      document.getElementById('recommendations').style.display = 'none';
      document.getElementById('downloadBtn').style.display = 'none';
      results = [];

      for (let i = 0; i < endpoints.length; i++) {
        const endpoint = endpoints[i];
        const result = await testEndpoint(endpoint);
        results.push(result);
        displayResult(result);
        updateStats();

        const progress = ((i + 1) / endpoints.length) * 100;
        document.getElementById('progress').style.width = progress + '%';
      }

      document.getElementById('status').textContent = 'TERMIN√â';
      document.getElementById('status').className = 'status success';
      generateRecommendations();
      document.getElementById('downloadBtn').style.display = 'flex';
    }

    async function runQuickTest() {
      document.getElementById('status').textContent = 'TEST RAPIDE';
      document.getElementById('status').className = 'status running';
      document.getElementById('results').innerHTML = '';
      document.getElementById('downloadBtn').style.display = 'none';
      results = [];

      const critical = endpoints.filter(e => e.critical);
      for (let i = 0; i < critical.length; i++) {
        const result = await testEndpoint(critical[i]);
        results.push(result);
        displayResult(result);
        updateStats();
        document.getElementById('progress').style.width = ((i + 1) / critical.length) * 100 + '%';
      }

      document.getElementById('status').textContent = 'TERMIN√â';
      document.getElementById('status').className = 'status success';
      generateRecommendations();
      document.getElementById('downloadBtn').style.display = 'flex';
    }

    async function runStressTest() {
      document.getElementById('status').textContent = 'STRESS TEST';
      document.getElementById('status').className = 'status running';
      document.getElementById('results').innerHTML = '';
      results = [];

      // Run each critical endpoint 5 times
      const critical = endpoints.filter(e => e.critical);
      const totalTests = critical.length * 5;
      let count = 0;

      for (const endpoint of critical) {
        for (let i = 0; i < 5; i++) {
          const result = await testEndpoint(endpoint);
          result.name = `${endpoint.name} (test ${i + 1}/5)`;
          results.push(result);
          displayResult(result);
          updateStats();
          count++;
          document.getElementById('progress').style.width = (count / totalTests) * 100 + '%';
        }
      }

      document.getElementById('status').textContent = 'TERMIN√â';
      document.getElementById('status').className = 'status success';
      generateRecommendations();
      document.getElementById('downloadBtn').style.display = 'flex';
    }

    function showApiDetails(apiName) {
      const result = results.find(r => r.name === apiName);
      if (!result) return;

      const perfClass = getPerformanceClass(result.time, result.critical);
      const badge = getPerformanceBadgeText(result.time, result.critical);

      let timingHtml = '';
      if (result.timing) {
        const t = result.timing;
        const total = t.dns + t.tcp + t.tls + t.request + t.response;

        timingHtml = `
          <h3 style="color: #1a202c; font-size: 20px; font-weight: 800; margin-top: 30px; margin-bottom: 15px;">
            ‚è±Ô∏è Breakdown Temporel
          </h3>
          <div class="timing-bar">
            ${t.dns > 0 ? `<div class="timing-segment timing-segment-dns" style="width: ${(t.dns/total*100)}%" title="DNS Lookup: ${t.dns}ms">${t.dns}ms</div>` : ''}
            ${t.tcp > 0 ? `<div class="timing-segment timing-segment-tcp" style="width: ${(t.tcp/total*100)}%" title="TCP Connection: ${t.tcp}ms">${t.tcp}ms</div>` : ''}
            ${t.tls > 0 ? `<div class="timing-segment timing-segment-tls" style="width: ${(t.tls/total*100)}%" title="TLS Handshake: ${t.tls}ms">${t.tls}ms</div>` : ''}
            ${t.request > 0 ? `<div class="timing-segment timing-segment-request" style="width: ${(t.request/total*100)}%" title="Request Sent: ${t.request}ms">${t.request}ms</div>` : ''}
            ${t.response > 0 ? `<div class="timing-segment timing-segment-response" style="width: ${(t.response/total*100)}%" title="Response Received: ${t.response}ms">${t.response}ms</div>` : ''}
          </div>
          <div class="timing-legend">
            ${t.dns > 0 ? '<div class="timing-legend-item"><div class="timing-legend-color timing-segment-dns"></div><span><strong>DNS Lookup:</strong> ' + t.dns + 'ms</span></div>' : ''}
            ${t.tcp > 0 ? '<div class="timing-legend-item"><div class="timing-legend-color timing-segment-tcp"></div><span><strong>TCP Connection:</strong> ' + t.tcp + 'ms</span></div>' : ''}
            ${t.tls > 0 ? '<div class="timing-legend-item"><div class="timing-legend-color timing-segment-tls"></div><span><strong>TLS Handshake:</strong> ' + t.tls + 'ms</span></div>' : ''}
            ${t.request > 0 ? '<div class="timing-legend-item"><div class="timing-legend-color timing-segment-request"></div><span><strong>Request:</strong> ' + t.request + 'ms</span></div>' : ''}
            ${t.response > 0 ? '<div class="timing-legend-item"><div class="timing-legend-color timing-segment-response"></div><span><strong>Response:</strong> ' + t.response + 'ms</span></div>' : ''}
          </div>

          <h3 style="color: #1a202c; font-size: 20px; font-weight: 800; margin-top: 30px; margin-bottom: 15px;">
            üìä M√©triques D√©taill√©es
          </h3>
          <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">TRANSFER SIZE</div>
                <div style="font-size: 18px; font-weight: 700; color: #1a202c;">${(t.transferSize / 1024).toFixed(2)} KB</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">ENCODED BODY</div>
                <div style="font-size: 18px; font-weight: 700; color: #1a202c;">${(t.encodedBodySize / 1024).toFixed(2)} KB</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">DECODED BODY</div>
                <div style="font-size: 18px; font-weight: 700; color: #1a202c;">${(t.decodedBodySize / 1024).toFixed(2)} KB</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">COMPRESSION RATIO</div>
                <div style="font-size: 18px; font-weight: 700; color: #10b981;">${t.encodedBodySize > 0 ? (((t.decodedBodySize - t.encodedBodySize) / t.decodedBodySize * 100).toFixed(1)) : 0}%</div>
              </div>
            </div>
          </div>
        `;
      } else {
        timingHtml = `
          <div style="background: #fee2e2; border-radius: 12px; padding: 20px; margin-top: 20px; border-left: 4px solid #ef4444;">
            <p style="color: #991b1b; font-weight: 600;">‚ö†Ô∏è D√©tails de timing non disponibles</p>
            <p style="color: #7f1d1d; font-size: 13px; margin-top: 8px;">Les m√©triques de performance d√©taill√©es ne sont pas accessibles pour cette requ√™te.</p>
          </div>
        `;
      }

      const modalHtml = `
        <h2 style="color: #1a202c; font-size: 28px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
          üîç ${result.name}
          <span class="metric-badge badge-${perfClass === 'fast' ? 'excellent' : perfClass === 'medium' ? 'good' : 'critical'}">${badge}</span>
        </h2>
        <p style="color: #64748b; font-size: 14px; margin-bottom: 30px;">${result.url}</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white;">
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TEMPS TOTAL</div>
            <div style="font-size: 32px; font-weight: 800;">${result.time}ms</div>
          </div>
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 20px; color: white;">
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">STATUS HTTP</div>
            <div style="font-size: 32px; font-weight: 800;">${result.status}</div>
          </div>
          <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 12px; padding: 20px; color: white;">
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TAILLE DONN√âES</div>
            <div style="font-size: 32px; font-weight: 800;">${(result.size / 1024).toFixed(2)}KB</div>
          </div>
          <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 12px; padding: 20px; color: white;">
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TYPE</div>
            <div style="font-size: 20px; font-weight: 800;">${result.critical ? 'CRITIQUE' : 'STANDARD'}</div>
          </div>
        </div>

        ${timingHtml}

        <h3 style="color: #1a202c; font-size: 20px; font-weight: 800; margin-top: 30px; margin-bottom: 15px;">
          üí° Analyse & Recommandations
        </h3>
        <div style="background: #fef3c7; border-radius: 12px; padding: 20px; border-left: 4px solid #f59e0b;">
          ${analyzePerformance(result)}
        </div>
      `;

      document.getElementById('modalBody').innerHTML = modalHtml;
      document.getElementById('apiDetailModal').classList.add('active');
    }

    function analyzePerformance(result) {
      let analysis = [];

      if (result.time < 100) {
        analysis.push('‚úÖ <strong>Excellent:</strong> Temps de r√©ponse optimal, aucune action requise.');
      } else if (result.time < 300) {
        analysis.push('‚úÖ <strong>Bon:</strong> Performance acceptable.');
      } else if (result.time < 500) {
        analysis.push('‚ö†Ô∏è <strong>Lent:</strong> Optimisation recommand√©e.');
      } else {
        analysis.push('üî¥ <strong>Critique:</strong> Optimisation URGENTE requise!');
      }

      if (result.timing) {
        const t = result.timing;
        if (t.dns > 50) {
          analysis.push('‚ö†Ô∏è <strong>DNS Lookup lent</strong> (' + t.dns + 'ms): Consid√©rer un CDN ou DNS caching.');
        }
        if (t.tcp > 100) {
          analysis.push('‚ö†Ô∏è <strong>TCP Connection lent</strong> (' + t.tcp + 'ms): Probl√®me r√©seau ou serveur distant.');
        }
        if (t.tls > 100) {
          analysis.push('‚ö†Ô∏è <strong>TLS Handshake lent</strong> (' + t.tls + 'ms): Optimiser la configuration SSL/TLS.');
        }
        if (t.request > 100) {
          analysis.push('‚ö†Ô∏è <strong>Temps d\'envoi long</strong> (' + t.request + 'ms): V√©rifier la bande passante upload.');
        }
        if (t.response > 200) {
          analysis.push('üî¥ <strong>R√©ponse serveur lente</strong> (' + t.response + 'ms): Probl√®me de performance backend - Optimiser les requ√™tes DB, ajouter du caching.');
        }
        if (t.decodedBodySize > 500000) {
          analysis.push('‚ö†Ô∏è <strong>Payload volumineux</strong> (' + (t.decodedBodySize/1024).toFixed(0) + 'KB): Impl√©menter pagination ou r√©duire les donn√©es retourn√©es.');
        }
        if (t.encodedBodySize > 0 && ((t.decodedBodySize - t.encodedBodySize) / t.decodedBodySize) < 0.5) {
          analysis.push('üí° <strong>Compression faible</strong>: Am√©liorer la compression gzip/brotli c√¥t√© serveur.');
        }
      }

      if (result.size > 100000) {
        analysis.push('üì¶ <strong>Donn√©es volumineuses</strong>: Envisager pagination, lazy loading ou GraphQL.');
      }

      if (analysis.length === 1) {
        analysis.push('üéØ <strong>Conseil:</strong> Maintenir ce niveau de performance.');
      }

      return analysis.map(a => '<p style="margin: 10px 0; color: #92400e; font-size: 14px;">' + a + '</p>').join('');
    }

    function closeModal() {
      document.getElementById('apiDetailModal').classList.remove('active');
    }

    // Fermer le modal en cliquant en dehors
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('apiDetailModal');
      if (e.target === modal) {
        closeModal();
      }
    });

    function downloadReport() {
      if (results.length === 0) {
        alert('‚ùå Aucun test n\'a √©t√© effectu√©. Lancez un diagnostic d\'abord!');
        return;
      }

      // Calculer les statistiques
      const times = results.map(r => r.time);
      const avgTime = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
      const fastest = results.reduce((min, r) => r.time < min.time ? r : min, results[0]);
      const slowest = results.reduce((max, r) => r.time > max.time ? r : max, results[0]);

      // G√©n√©rer les recommandations
      const recommendations = [];
      const criticalSlow = results.filter(r => r.critical && r.time > 300);
      const nonCriticalSlow = results.filter(r => !r.critical && r.time > 500);
      const failed = results.filter(r => !r.success);
      const largeSizes = results.filter(r => r.size > 100000);

      if (criticalSlow.length > 0) {
        recommendations.push({
          type: 'critical',
          message: `${criticalSlow.length} API(s) critique(s) trop lente(s): ${criticalSlow.map(r => r.name).join(', ')} prennent plus de 300ms`,
          apis: criticalSlow.map(r => r.name)
        });
      }

      if (nonCriticalSlow.length > 0) {
        recommendations.push({
          type: 'warning',
          message: `${nonCriticalSlow.length} API(s) non-critique(s) lente(s)`,
          apis: nonCriticalSlow.map(r => r.name)
        });
      }

      if (failed.length > 0) {
        recommendations.push({
          type: 'error',
          message: `${failed.length} API(s) en √©chec`,
          apis: failed.map(r => r.name)
        });
      }

      if (largeSizes.length > 0) {
        recommendations.push({
          type: 'info',
          message: 'Donn√©es volumineuses d√©tect√©es',
          apis: largeSizes.map(r => ({ name: r.name, size: r.size }))
        });
      }

      // Cr√©er le rapport JSON complet
      const report = {
        metadata: {
          timestamp: new Date().toISOString(),
          dateFormatted: new Date().toLocaleString('fr-CA'),
          project: 'SAR - Solution Argent Rapide',
          testType: document.getElementById('status').textContent,
          userAgent: navigator.userAgent,
          browser: navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'Unknown',
          platform: navigator.platform,
          screenResolution: `${screen.width}x${screen.height}`,
          viewport: `${window.innerWidth}x${window.innerHeight}`
        },
        summary: {
          totalTests: results.length,
          successfulTests: results.filter(r => r.success).length,
          failedTests: results.filter(r => !r.success).length,
          averageResponseTime: avgTime,
          fastestAPI: {
            name: fastest.name,
            url: fastest.url,
            time: fastest.time
          },
          slowestAPI: {
            name: slowest.name,
            url: slowest.url,
            time: slowest.time
          }
        },
        results: results.map(r => ({
          name: r.name,
          url: r.url,
          responseTime: r.time,
          status: r.status,
          success: r.success,
          critical: r.critical,
          size: r.size,
          sizeKB: r.size ? (r.size / 1024).toFixed(2) : null,
          error: r.error || null,
          performance: getPerformanceClass(r.time, r.critical),
          performanceLabel: getPerformanceBadgeText(r.time, r.critical)
        })),
        performanceBreakdown: {
          excellent: results.filter(r => r.critical ? r.time < 100 : r.time < 200).length,
          good: results.filter(r => r.critical ? (r.time >= 100 && r.time < 300) : (r.time >= 200 && r.time < 500)).length,
          slow: results.filter(r => r.critical ? (r.time >= 300 && r.time < 500) : (r.time >= 500 && r.time < 1000)).length,
          critical: results.filter(r => r.critical ? r.time >= 500 : r.time >= 1000).length
        },
        recommendations: recommendations,
        rawData: {
          allResults: results
        }
      };

      // Cr√©er le blob et t√©l√©charger
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sar-performance-report-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      console.log('‚úÖ Rapport JSON t√©l√©charg√© avec succ√®s!');
      console.log('üìä Rapport:', report);
    }

    function getPerformanceBadgeText(time, critical) {
      if (critical) {
        if (time < 100) return 'EXCELLENT';
        if (time < 300) return 'BON';
        if (time < 500) return 'LENT';
        return 'CRITIQUE';
      } else {
        if (time < 200) return 'EXCELLENT';
        if (time < 500) return 'BON';
        if (time < 1000) return 'LENT';
        return 'CRITIQUE';
      }
    }
  </script>
</body>
</html>
