<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ COMMAND CENTER - Full Network Control</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      background: #000000;
      color: #00ff00;
      overflow: hidden;
      height: 100vh;
    }

    /* Main Grid Layout */
    .command-center {
      display: grid;
      grid-template-rows: 50px 1fr 180px;
      grid-template-columns: 300px 1fr 350px;
      height: 100vh;
      gap: 2px;
      background: #00ff00;
    }

    /* Top Header - Full Width */
    .top-header {
      grid-column: 1 / -1;
      background: linear-gradient(180deg, #0a0a0a 0%, #000000 100%);
      border-bottom: 2px solid #00ff00;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 255, 0, 0.5);
    }

    .header-title {
      font-size: 18px;
      font-weight: bold;
      color: #00ff00;
      text-shadow: 0 0 10px #00ff00;
      letter-spacing: 3px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pulse-dot {
      width: 12px;
      height: 12px;
      background: #00ff00;
      border-radius: 50%;
      animation: pulse 1s infinite;
      box-shadow: 0 0 10px #00ff00;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .header-stats {
      display: flex;
      gap: 30px;
      font-size: 11px;
    }

    .stat-box {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #00ff00;
    }

    .stat-label {
      font-size: 9px;
      color: #666;
      text-transform: uppercase;
    }

    /* Left Sidebar - System Status */
    .left-panel {
      background: #000000;
      overflow-y: auto;
      padding: 15px;
    }

    .panel-section {
      margin-bottom: 20px;
    }

    .section-header {
      font-size: 11px;
      color: #00ff00;
      background: rgba(0, 255, 0, 0.1);
      padding: 6px 10px;
      border-left: 3px solid #00ff00;
      margin-bottom: 10px;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .status-item {
      padding: 8px 10px;
      margin: 5px 0;
      background: rgba(0, 255, 0, 0.05);
      border-left: 2px solid transparent;
      font-size: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .status-item:hover {
      background: rgba(0, 255, 0, 0.1);
      border-left-color: #00ff00;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    .status-indicator.green {
      background: #00ff00;
      box-shadow: 0 0 8px #00ff00;
    }

    .status-indicator.red {
      background: #ff0000;
      box-shadow: 0 0 8px #ff0000;
    }

    .status-indicator.yellow {
      background: #ffff00;
      box-shadow: 0 0 8px #ffff00;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Center Main View - Network Map + Routes */
    .center-panel {
      background: #000000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .map-container {
      flex: 1;
      position: relative;
      background: radial-gradient(circle at center, rgba(0, 255, 0, 0.1) 0%, transparent 70%);
      border-bottom: 2px solid #00ff00;
    }

    #networkMap {
      width: 100%;
      height: 100%;
    }

    .map-legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border: 1px solid #00ff00;
      border-radius: 5px;
      font-size: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .routes-stream {
      height: 150px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      font-size: 10px;
    }

    .route-entry {
      padding: 4px 8px;
      margin: 2px 0;
      border-left: 2px solid #00ff00;
      background: rgba(0, 255, 0, 0.05);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .route-entry.error {
      border-left-color: #ff0000;
      background: rgba(255, 0, 0, 0.05);
    }

    .route-entry.warning {
      border-left-color: #ffff00;
      background: rgba(255, 255, 0, 0.05);
    }

    .route-timestamp {
      color: #666;
      margin-right: 8px;
    }

    .route-method {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: bold;
      margin-right: 8px;
    }

    .route-method.GET { background: rgba(0, 255, 0, 0.3); color: #00ff00; }
    .route-method.POST { background: rgba(0, 150, 255, 0.3); color: #0096ff; }

    /* Right Sidebar - Alerts & Controls */
    .right-panel {
      background: #000000;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .alerts-section {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .alert-box {
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border-left: 3px solid;
      font-size: 10px;
      animation: alertPulse 2s infinite;
    }

    .alert-box.critical {
      background: rgba(255, 0, 0, 0.1);
      border-left-color: #ff0000;
    }

    .alert-box.high {
      background: rgba(255, 165, 0, 0.1);
      border-left-color: #ffa500;
    }

    .alert-box.medium {
      background: rgba(255, 255, 0, 0.1);
      border-left-color: #ffff00;
    }

    @keyframes alertPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .alert-title {
      font-weight: bold;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .alert-detail {
      color: #888;
      font-size: 9px;
    }

    .controls-section {
      padding: 15px;
      border-top: 2px solid #00ff00;
      background: rgba(0, 255, 0, 0.05);
    }

    .control-btn {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: linear-gradient(135deg, rgba(0, 255, 0, 0.2) 0%, rgba(0, 255, 0, 0.1) 100%);
      border: 1px solid #00ff00;
      color: #00ff00;
      font-family: inherit;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .control-btn:hover {
      background: rgba(0, 255, 0, 0.3);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
      transform: translateY(-2px);
    }

    .control-btn:active {
      transform: translateY(0);
    }

    .control-btn.danger {
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.2) 0%, rgba(255, 0, 0, 0.1) 100%);
      border-color: #ff0000;
      color: #ff0000;
    }

    .control-btn.danger:hover {
      background: rgba(255, 0, 0, 0.3);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }

    /* Bottom Footer - Global Metrics */
    .bottom-footer {
      grid-column: 1 / -1;
      background: #000000;
      border-top: 2px solid #00ff00;
      padding: 15px 20px;
      display: flex;
      gap: 20px;
      overflow-x: auto;
    }

    .metric-card {
      flex: 1;
      min-width: 200px;
      background: rgba(0, 255, 0, 0.05);
      border: 1px solid #00ff00;
      border-radius: 8px;
      padding: 15px;
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff00, transparent);
      animation: scan 3s linear infinite;
    }

    @keyframes scan {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .metric-label {
      font-size: 9px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #00ff00;
      text-shadow: 0 0 10px #00ff00;
    }

    .metric-graph {
      height: 40px;
      margin-top: 10px;
      position: relative;
    }

    .graph-bar {
      position: absolute;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, #00ff00 0%, rgba(0, 255, 0, 0.2) 100%);
      animation: barGrow 0.5s ease;
    }

    @keyframes barGrow {
      from { height: 0; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff00;
      border-radius: 3px;
    }

    /* Scan Line Effect */
    .scan-line {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff00, transparent);
      box-shadow: 0 0 10px #00ff00;
      animation: scanVertical 4s linear infinite;
      pointer-events: none;
      z-index: 9999;
    }

    @keyframes scanVertical {
      0% { top: 0; opacity: 0; }
      50% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- Scan Line Effect -->
  <div class="scan-line"></div>

  <div class="command-center">
    <!-- Top Header -->
    <div class="top-header">
      <div class="header-title">
        <div class="pulse-dot"></div>
        üéØ SAR COMMAND CENTER - FULL NETWORK CONTROL
      </div>
      <div class="header-stats">
        <div class="stat-box">
          <div class="stat-value" id="totalRoutes">69</div>
          <div class="stat-label">Routes</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="activeRoutes">0</div>
          <div class="stat-label">Active</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalRequests">0</div>
          <div class="stat-label">Requests</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="errorCount" style="color: #ff0000;">0</div>
          <div class="stat-label">Errors</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="avgLatency">0ms</div>
          <div class="stat-label">Latency</div>
        </div>
      </div>
    </div>

    <!-- Left Sidebar - System Status -->
    <div class="left-panel">
      <div class="panel-section">
        <div class="section-header">‚óà SYSTEM STATUS</div>
        <div class="status-item">
          <span>Platform</span>
          <span id="platform">-</span>
        </div>
        <div class="status-item">
          <span>Node Version</span>
          <span id="nodeVersion">-</span>
        </div>
        <div class="status-item">
          <span>Hostname</span>
          <span id="hostname">-</span>
        </div>
        <div class="status-item">
          <span>User</span>
          <span id="user">-</span>
        </div>
      </div>

      <div class="panel-section">
        <div class="section-header">‚óà PORTS</div>
        <div id="portsList">
          <!-- Ports will be injected -->
        </div>
      </div>

      <div class="panel-section">
        <div class="section-header">‚óà EXTERNAL SERVICES</div>
        <div id="servicesList">
          <!-- Services will be injected -->
        </div>
      </div>

      <div class="panel-section">
        <div class="section-header">‚óà DATABASE</div>
        <div class="status-item">
          <span>Type</span>
          <span id="dbType">-</span>
        </div>
        <div class="status-item">
          <span>Tables</span>
          <span id="dbTables">-</span>
        </div>
      </div>
    </div>

    <!-- Center Panel - Network Map + Routes Stream -->
    <div class="center-panel">
      <div class="map-container">
        <canvas id="networkMap"></canvas>
        <div class="map-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: #00ff00;"></div>
            <span>Routes Online</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #ff0000;"></div>
            <span>Errors</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #0096ff;"></div>
            <span>External Services</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #ffff00;"></div>
            <span>Database</span>
          </div>
        </div>
      </div>
      <div class="routes-stream" id="routesStream">
        <!-- Live route activity will appear here -->
      </div>
    </div>

    <!-- Right Sidebar - Alerts & Controls -->
    <div class="right-panel">
      <div class="alerts-section">
        <div class="section-header">‚ö†Ô∏è SECURITY ALERTS</div>
        <div id="alertsList">
          <!-- Alerts will be injected -->
        </div>
      </div>

      <div class="controls-section">
        <div class="section-header">‚ö° QUICK ACTIONS</div>
        <button class="control-btn" onclick="refreshAll()">üîÑ REFRESH ALL</button>
        <button class="control-btn" onclick="runScan()">üîç RUN DEEP SCAN</button>
        <button class="control-btn" onclick="viewLogs()">üìã VIEW LOGS</button>
        <button class="control-btn" onclick="openDashboard()">üìä ANALYTICS</button>
        <button class="control-btn danger" onclick="clearCache()">üóëÔ∏è CLEAR CACHE</button>
      </div>
    </div>

    <!-- Bottom Footer - Global Metrics -->
    <div class="bottom-footer">
      <div class="metric-card">
        <div class="metric-label">CPU Usage</div>
        <div class="metric-value" id="cpuUsage">0%</div>
        <div class="metric-graph" id="cpuGraph"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Memory Usage</div>
        <div class="metric-value" id="memUsage">0 MB</div>
        <div class="metric-graph" id="memGraph"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Network Traffic</div>
        <div class="metric-value" id="netTraffic">0 KB/s</div>
        <div class="metric-graph" id="netGraph"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Active Connections</div>
        <div class="metric-value" id="activeConns">0</div>
        <div class="metric-graph" id="connGraph"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Response Time</div>
        <div class="metric-value" id="respTime">0ms</div>
        <div class="metric-graph" id="respGraph"></div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dllyzfuqjzuhvshrlmuq.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsbHl6ZnVxanp1aHZzaHJsbXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTU5ODEsImV4cCI6MjA4MTU3MTk4MX0.xskVblRlKdbTST1Mdgz76oR7N2rDq8ZOUgaN-f_TTM4'

    let reconReport = null
    let performanceData = {}
    let metricsHistory = {
      cpu: [],
      mem: [],
      net: [],
      conn: [],
      resp: []
    }

    // Load deep recon report
    async function loadReconReport() {
      try {
        const response = await fetch('/deep-recon-report.json')
        reconReport = await response.json()
        updateSystemInfo()
        updateAlerts()
      } catch (error) {
        console.error('Failed to load recon report:', error)
      }
    }

    // Load performance data from Supabase
    async function loadPerformanceData() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/vw_route_performance?select=*`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        })

        if (response.ok) {
          const data = await response.json()
          performanceData = {}
          data.forEach(route => {
            performanceData[route.route_path] = route
          })

          updateHeaderStats()
          simulateRouteActivity()
        }
      } catch (error) {
        console.error('Error fetching performance data:', error)
      }
    }

    // Update system info
    function updateSystemInfo() {
      if (!reconReport) return

      document.getElementById('platform').textContent = reconReport.system.platform
      document.getElementById('nodeVersion').textContent = reconReport.system.node_version
      document.getElementById('hostname').textContent = reconReport.system.hostname
      document.getElementById('user').textContent = reconReport.system.user

      // Ports
      const portsList = document.getElementById('portsList')
      portsList.innerHTML = reconReport.ports.open_ports.map(port => `
        <div class="status-item">
          <span>Port ${port}</span>
          <div class="status-indicator green"></div>
        </div>
      `).join('')

      // External services
      const servicesList = document.getElementById('servicesList')
      servicesList.innerHTML = reconReport.external_services.map(service => `
        <div class="status-item">
          <span>${service.name}</span>
          <div class="status-indicator green"></div>
        </div>
      `).join('')

      // Database
      document.getElementById('dbType').textContent = reconReport.database.type
      document.getElementById('dbTables').textContent = reconReport.database.tables_count
    }

    // Update alerts
    function updateAlerts() {
      if (!reconReport) return

      const alertsList = document.getElementById('alertsList')
      alertsList.innerHTML = reconReport.risks.map(risk => `
        <div class="alert-box ${risk.severity.toLowerCase()}">
          <div class="alert-title">${risk.type}</div>
          <div class="alert-detail">${risk.detail}</div>
        </div>
      `).join('')
    }

    // Update header stats
    function updateHeaderStats() {
      let totalReqs = 0
      let totalErrors = 0
      let totalLatency = 0
      let activeCount = 0

      Object.values(performanceData).forEach(perf => {
        totalReqs += parseInt(perf.total_requests)
        totalErrors += parseInt(perf.error_count)
        totalLatency += parseFloat(perf.avg_response_time_ms)
        if (parseFloat(perf.error_rate) === 0) activeCount++
      })

      const avgLatency = Object.keys(performanceData).length > 0
        ? totalLatency / Object.keys(performanceData).length
        : 0

      document.getElementById('activeRoutes').textContent = activeCount
      document.getElementById('totalRequests').textContent = totalReqs
      document.getElementById('errorCount').textContent = totalErrors
      document.getElementById('avgLatency').textContent = Math.floor(avgLatency) + 'ms'
    }

    // Simulate route activity
    function simulateRouteActivity() {
      const stream = document.getElementById('routesStream')
      const routes = reconReport ? reconReport.routes : []

      if (routes.length === 0) return

      setInterval(() => {
        const route = routes[Math.floor(Math.random() * routes.length)]
        const method = route.methods[0] || 'GET'
        const perf = performanceData[route.path]

        let status = 'success'
        if (perf && parseFloat(perf.error_rate) > 0) {
          status = Math.random() > 0.7 ? 'error' : 'success'
        }

        const timestamp = new Date().toLocaleTimeString()
        const latency = perf ? parseFloat(perf.avg_response_time_ms).toFixed(0) : Math.floor(Math.random() * 100)

        const entry = document.createElement('div')
        entry.className = `route-entry ${status === 'error' ? 'error' : ''}`
        entry.innerHTML = `
          <span class="route-timestamp">[${timestamp}]</span>
          <span class="route-method ${method}">${method}</span>
          <span>${route.path}</span>
          <span style="color: #666; margin-left: 10px;">${latency}ms</span>
        `

        stream.insertBefore(entry, stream.firstChild)

        // Keep only last 50 entries
        while (stream.children.length > 50) {
          stream.removeChild(stream.lastChild)
        }
      }, 2000)
    }

    // Draw network map
    function drawNetworkMap() {
      const canvas = document.getElementById('networkMap')
      const ctx = canvas.getContext('2d')

      canvas.width = canvas.offsetWidth
      canvas.height = canvas.offsetHeight

      const centerX = canvas.width / 2
      const centerY = canvas.height / 2

      // Draw central hub (SAR System)
      ctx.beginPath()
      ctx.arc(centerX, centerY, 40, 0, Math.PI * 2)
      ctx.fillStyle = '#00ff00'
      ctx.fill()
      ctx.shadowBlur = 30
      ctx.shadowColor = '#00ff00'

      // Draw text
      ctx.shadowBlur = 0
      ctx.fillStyle = '#000'
      ctx.font = 'bold 14px monospace'
      ctx.textAlign = 'center'
      ctx.textBaseline = 'middle'
      ctx.fillText('SAR', centerX, centerY)

      if (!reconReport) return

      // Draw routes ring
      const routeCount = Math.min(reconReport.routes.length, 20)
      const routeRadius = 150
      for (let i = 0; i < routeCount; i++) {
        const angle = (i / routeCount) * Math.PI * 2
        const x = centerX + Math.cos(angle) * routeRadius
        const y = centerY + Math.sin(angle) * routeRadius

        // Line
        ctx.beginPath()
        ctx.moveTo(centerX, centerY)
        ctx.lineTo(x, y)
        ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)'
        ctx.lineWidth = 1
        ctx.stroke()

        // Node
        ctx.beginPath()
        ctx.arc(x, y, 8, 0, Math.PI * 2)
        ctx.fillStyle = '#00ff00'
        ctx.fill()
        ctx.shadowBlur = 10
        ctx.shadowColor = '#00ff00'
      }

      // Draw external services ring
      const services = reconReport.external_services
      const serviceRadius = 250
      services.forEach((service, i) => {
        const angle = (i / services.length) * Math.PI * 2
        const x = centerX + Math.cos(angle) * serviceRadius
        const y = centerY + Math.sin(angle) * serviceRadius

        // Line
        ctx.beginPath()
        ctx.moveTo(centerX, centerY)
        ctx.lineTo(x, y)
        ctx.strokeStyle = 'rgba(0, 150, 255, 0.3)'
        ctx.lineWidth = 1
        ctx.setLineDash([5, 5])
        ctx.stroke()
        ctx.setLineDash([])

        // Node
        ctx.beginPath()
        ctx.arc(x, y, 12, 0, Math.PI * 2)
        ctx.fillStyle = '#0096ff'
        ctx.fill()
        ctx.shadowBlur = 15
        ctx.shadowColor = '#0096ff'

        // Label
        ctx.shadowBlur = 0
        ctx.fillStyle = '#0096ff'
        ctx.font = '10px monospace'
        ctx.fillText(service.name, x, y + 20)
      })

      // Animate particles
      animateParticles(ctx, centerX, centerY, routeRadius)
    }

    let particles = []

    function animateParticles(ctx, centerX, centerY, radius) {
      // Create particles
      if (Math.random() > 0.7 && particles.length < 20) {
        particles.push({
          angle: Math.random() * Math.PI * 2,
          distance: 0,
          speed: 2 + Math.random() * 2,
          color: Math.random() > 0.5 ? '#00ff00' : '#0096ff'
        })
      }

      // Update and draw particles
      particles = particles.filter(p => {
        p.distance += p.speed
        if (p.distance > radius) return false

        const x = centerX + Math.cos(p.angle) * p.distance
        const y = centerY + Math.sin(p.angle) * p.distance

        ctx.beginPath()
        ctx.arc(x, y, 2, 0, Math.PI * 2)
        ctx.fillStyle = p.color
        ctx.fill()
        ctx.shadowBlur = 10
        ctx.shadowColor = p.color

        return true
      })

      requestAnimationFrame(() => animateParticles(ctx, centerX, centerY, radius))
    }

    // Update metrics graphs
    function updateMetrics() {
      // Simulate metrics (in real app, fetch from server)
      const cpu = 30 + Math.random() * 40
      const mem = 1024 + Math.random() * 512
      const net = Math.floor(Math.random() * 1000)
      const conn = Math.floor(10 + Math.random() * 20)
      const resp = 50 + Math.random() * 100

      document.getElementById('cpuUsage').textContent = cpu.toFixed(1) + '%'
      document.getElementById('memUsage').textContent = mem.toFixed(0) + ' MB'
      document.getElementById('netTraffic').textContent = net + ' KB/s'
      document.getElementById('activeConns').textContent = conn
      document.getElementById('respTime').textContent = resp.toFixed(0) + 'ms'

      // Update history
      metricsHistory.cpu.push(cpu)
      metricsHistory.mem.push(mem)
      metricsHistory.net.push(net)
      metricsHistory.conn.push(conn)
      metricsHistory.resp.push(resp)

      // Keep only last 50 points
      Object.keys(metricsHistory).forEach(key => {
        if (metricsHistory[key].length > 50) {
          metricsHistory[key].shift()
        }
      })

      // Draw graphs
      drawGraph('cpuGraph', metricsHistory.cpu, 100)
      drawGraph('memGraph', metricsHistory.mem, 2048)
      drawGraph('netGraph', metricsHistory.net, 1000)
      drawGraph('connGraph', metricsHistory.conn, 50)
      drawGraph('respGraph', metricsHistory.resp, 200)
    }

    function drawGraph(containerId, data, max) {
      const container = document.getElementById(containerId)
      container.innerHTML = ''

      const width = container.offsetWidth
      const height = container.offsetHeight
      const barWidth = width / 50

      data.forEach((value, i) => {
        const barHeight = (value / max) * height
        const bar = document.createElement('div')
        bar.className = 'graph-bar'
        bar.style.left = (i * barWidth) + 'px'
        bar.style.height = barHeight + 'px'
        container.appendChild(bar)
      })
    }

    // Control functions
    function refreshAll() {
      loadReconReport()
      loadPerformanceData()
      addRouteEntry('SYSTEM', 'Refreshing all data...', 'success')
    }

    function runScan() {
      addRouteEntry('SYSTEM', 'Running deep recon scan...', 'success')
      setTimeout(() => {
        window.location.href = '/control-panel-complete.html'
      }, 1000)
    }

    function viewLogs() {
      addRouteEntry('SYSTEM', 'Opening logs viewer...', 'success')
    }

    function openDashboard() {
      window.open('/admin/dashboard', '_blank')
    }

    function clearCache() {
      addRouteEntry('SYSTEM', 'Clearing cache...', 'warning')
      setTimeout(() => {
        addRouteEntry('SYSTEM', 'Cache cleared successfully', 'success')
      }, 1000)
    }

    function addRouteEntry(method, path, status) {
      const stream = document.getElementById('routesStream')
      const timestamp = new Date().toLocaleTimeString()

      const entry = document.createElement('div')
      entry.className = `route-entry ${status === 'error' ? 'error' : status === 'warning' ? 'warning' : ''}`
      entry.innerHTML = `
        <span class="route-timestamp">[${timestamp}]</span>
        <span class="route-method ${method}">${method}</span>
        <span>${path}</span>
      `

      stream.insertBefore(entry, stream.firstChild)
    }

    // Initialize
    async function init() {
      await loadReconReport()
      await loadPerformanceData()
      drawNetworkMap()

      // Update metrics every 2 seconds
      setInterval(updateMetrics, 2000)

      // Refresh data every 10 seconds
      setInterval(() => {
        loadPerformanceData()
      }, 10000)

      // Redraw network map every 5 seconds
      setInterval(drawNetworkMap, 5000)
    }

    window.addEventListener('load', init)
    window.addEventListener('resize', drawNetworkMap)
  </script>
</body>
</html>
