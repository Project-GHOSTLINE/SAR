<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SAR - Outil de coordonn√©es PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e293b; color: white; }

    .header { background: #0f172a; padding: 20px; text-align: center; border-bottom: 2px solid #2563eb; }
    .header h1 { color: #2563eb; margin-bottom: 10px; }
    .header p { color: #94a3b8; }

    .controls { background: #334155; padding: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .controls label { color: #94a3b8; }
    .controls input[type="file"] { color: white; }
    .controls select, .controls input[type="number"] { padding: 8px 12px; border-radius: 6px; border: none; background: #1e293b; color: white; }
    .btn { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn:hover { background: #1d4ed8; }
    .btn-green { background: #16a34a; }
    .btn-green:hover { background: #15803d; }

    .main { display: flex; gap: 20px; padding: 20px; }

    .pdf-container { flex: 1; background: #475569; border-radius: 12px; padding: 20px; overflow: auto; max-height: 80vh; }
    .page-wrapper { position: relative; margin-bottom: 20px; background: white; display: inline-block; cursor: crosshair; }
    .page-wrapper canvas { display: block; }
    .click-marker { position: absolute; width: 20px; height: 20px; background: rgba(37, 99, 235, 0.5); border: 2px solid #2563eb; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
    .field-preview { position: absolute; background: rgba(22, 163, 74, 0.3); border: 2px dashed #16a34a; pointer-events: none; }

    .sidebar { width: 400px; background: #334155; border-radius: 12px; padding: 20px; }
    .sidebar h2 { color: #2563eb; margin-bottom: 15px; font-size: 18px; }

    .coord-display { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .coord-display p { margin-bottom: 8px; font-family: monospace; font-size: 14px; }
    .coord-display strong { color: #2563eb; }

    .size-controls { margin-bottom: 20px; }
    .size-controls label { display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px; }
    .size-controls input { width: 100%; padding: 8px; border-radius: 6px; border: none; background: #1e293b; color: white; margin-bottom: 10px; }

    .saved-fields { max-height: 300px; overflow-y: auto; }
    .saved-field { background: #1e293b; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; font-size: 12px; position: relative; }
    .saved-field .delete-btn { position: absolute; top: 5px; right: 5px; background: #dc2626; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
    .saved-field .type-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-bottom: 5px; }
    .saved-field .type-badge.initials { background: #f59e0b; color: black; }
    .saved-field .type-badge.signature { background: #2563eb; color: white; }

    .output-section { margin-top: 20px; }
    .output-section textarea { width: 100%; height: 150px; background: #1e293b; color: #4ade80; border: none; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; }

    .instructions { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .instructions h3 { color: #f59e0b; margin-bottom: 10px; font-size: 14px; }
    .instructions ol { padding-left: 20px; color: #94a3b8; font-size: 13px; line-height: 1.8; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üéØ SAR - Outil de coordonn√©es PDF</h1>
    <p>Clique sur le PDF pour d√©finir les positions exactes des signatures et initiales</p>
  </div>

  <div class="controls">
    <div>
      <label>üìÑ Charger un PDF: </label>
      <input type="file" id="pdfInput" accept=".pdf">
    </div>
    <div>
      <label>Page: </label>
      <select id="pageSelect"></select>
    </div>
    <div>
      <label>Type: </label>
      <select id="fieldType">
        <option value="initials">Initiales</option>
        <option value="signature">Signature</option>
      </select>
    </div>
    <button class="btn btn-green" id="copyBtn">üìã Copier le code</button>
    <button class="btn" id="saveTemplateBtn" style="background: #7c3aed;">üíæ Sauvegarder dans SAR</button>
    <button class="btn" id="openDashboardBtn" style="background: #0ea5e9;">üöÄ Ouvrir Dashboard SAR</button>
  </div>

  <div class="main">
    <div class="pdf-container" id="pdfContainer">
      <p style="color: #94a3b8; text-align: center; padding: 50px;">
        üëÜ Charge un PDF pour commencer
      </p>
    </div>

    <div class="sidebar">
      <div class="instructions">
        <h3>üìã Instructions</h3>
        <ol>
          <li>Charge ton PDF (Contrat ou Annexe)</li>
          <li>S√©lectionne le type (Initiales ou Signature)</li>
          <li>Clique exactement sur le [INIT] ou [SIGNATURE]</li>
          <li>Ajuste la taille si n√©cessaire</li>
          <li>R√©p√®te pour chaque page</li>
          <li>Sauvegarde dans SAR</li>
        </ol>
      </div>

      <h2>üìç Position actuelle</h2>
      <div class="coord-display">
        <p>Page: <strong id="currentPage">-</strong></p>
        <p>X: <strong id="currentX">-</strong></p>
        <p>Y: <strong id="currentY">-</strong></p>
        <p>Type: <strong id="currentType">-</strong></p>
      </div>

      <div class="size-controls">
        <label>Largeur (width):</label>
        <input type="number" id="fieldWidth" value="80">
        <label>Hauteur (height):</label>
        <input type="number" id="fieldHeight" value="25">
        <button class="btn" id="saveField">‚ûï Ajouter ce champ</button>
      </div>

      <h2>‚úÖ Champs enregistr√©s</h2>
      <div class="saved-fields" id="savedFields">
        <p style="color: #94a3b8; font-size: 13px;">Aucun champ enregistr√©</p>
      </div>

      <div class="output-section">
        <h2>üìù Code √† copier</h2>
        <textarea id="outputCode" readonly>// Clique sur le PDF pour g√©n√©rer le code</textarea>
      </div>
    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // D√©tecter l'environnement
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000'
      : window.location.origin;

    let pdfDoc = null;
    let currentPage = 1;
    let savedFields = [];
    let lastClickX = 0;
    let lastClickY = 0;
    let scale = 1.5;

    // Charger le PDF
    document.getElementById('pdfInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      // Remplir le select des pages
      const pageSelect = document.getElementById('pageSelect');
      pageSelect.innerHTML = '';
      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Page ${i}`;
        pageSelect.appendChild(option);
      }

      renderPage(1);
    });

    // Changer de page
    document.getElementById('pageSelect').addEventListener('change', (e) => {
      renderPage(parseInt(e.target.value));
    });

    // Rendre une page
    async function renderPage(pageNum) {
      currentPage = pageNum;
      document.getElementById('currentPage').textContent = pageNum;

      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale });

      const container = document.getElementById('pdfContainer');
      container.innerHTML = '';

      const wrapper = document.createElement('div');
      wrapper.className = 'page-wrapper';
      wrapper.id = 'pageWrapper';

      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      wrapper.appendChild(canvas);
      container.appendChild(wrapper);

      // Ajouter les marqueurs des champs existants pour cette page
      renderExistingFields(pageNum, wrapper, viewport.height);

      // √âv√©nement clic
      wrapper.addEventListener('click', (e) => {
        const rect = wrapper.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        // Convertir en coordonn√©es PDF (sans scale)
        const pdfX = Math.round(clickX / scale);
        const pdfY = Math.round(clickY / scale);

        lastClickX = pdfX;
        lastClickY = pdfY;

        document.getElementById('currentX').textContent = pdfX;
        document.getElementById('currentY').textContent = pdfY;
        document.getElementById('currentType').textContent = document.getElementById('fieldType').value;

        // Afficher le marqueur
        const existingMarker = wrapper.querySelector('.click-marker');
        if (existingMarker) existingMarker.remove();

        const marker = document.createElement('div');
        marker.className = 'click-marker';
        marker.style.left = clickX + 'px';
        marker.style.top = clickY + 'px';
        wrapper.appendChild(marker);

        // Afficher l'aper√ßu du champ
        updateFieldPreview(wrapper, clickX, clickY);
      });
    }

    // Aper√ßu du champ
    function updateFieldPreview(wrapper, clickX, clickY) {
      const existingPreview = wrapper.querySelector('.field-preview');
      if (existingPreview) existingPreview.remove();

      const width = parseInt(document.getElementById('fieldWidth').value) * scale;
      const height = parseInt(document.getElementById('fieldHeight').value) * scale;

      const preview = document.createElement('div');
      preview.className = 'field-preview';
      preview.style.left = clickX + 'px';
      preview.style.top = clickY + 'px';
      preview.style.width = width + 'px';
      preview.style.height = height + 'px';
      wrapper.appendChild(preview);
    }

    // Mettre √† jour l'aper√ßu quand on change la taille
    document.getElementById('fieldWidth').addEventListener('input', updatePreviewFromInputs);
    document.getElementById('fieldHeight').addEventListener('input', updatePreviewFromInputs);

    function updatePreviewFromInputs() {
      const wrapper = document.getElementById('pageWrapper');
      if (!wrapper) return;
      const marker = wrapper.querySelector('.click-marker');
      if (!marker) return;

      const clickX = parseFloat(marker.style.left);
      const clickY = parseFloat(marker.style.top);
      updateFieldPreview(wrapper, clickX, clickY);
    }

    // Sauvegarder un champ
    document.getElementById('saveField').addEventListener('click', () => {
      if (lastClickX === 0 && lastClickY === 0) {
        alert('Clique d\'abord sur le PDF!');
        return;
      }

      const field = {
        id: `field_${savedFields.length + 1}`,
        type: document.getElementById('fieldType').value,
        page: currentPage,
        x: lastClickX,
        y: lastClickY,
        width: parseInt(document.getElementById('fieldWidth').value),
        height: parseInt(document.getElementById('fieldHeight').value)
      };

      savedFields.push(field);
      renderSavedFields();
      generateCode();

      // Re-render pour montrer le champ ajout√©
      renderPage(currentPage);
    });

    // Afficher les champs existants sur la page
    function renderExistingFields(pageNum, wrapper, canvasHeight) {
      savedFields.filter(f => f.page === pageNum).forEach(field => {
        const fieldEl = document.createElement('div');
        fieldEl.className = 'field-preview';
        fieldEl.style.left = (field.x * scale) + 'px';
        fieldEl.style.top = (field.y * scale) + 'px';
        fieldEl.style.width = (field.width * scale) + 'px';
        fieldEl.style.height = (field.height * scale) + 'px';
        fieldEl.style.background = field.type === 'initials' ? 'rgba(245, 158, 11, 0.3)' : 'rgba(37, 99, 235, 0.3)';
        fieldEl.style.borderColor = field.type === 'initials' ? '#f59e0b' : '#2563eb';
        wrapper.appendChild(fieldEl);
      });
    }

    // Afficher les champs sauvegard√©s
    function renderSavedFields() {
      const container = document.getElementById('savedFields');

      if (savedFields.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; font-size: 13px;">Aucun champ enregistr√©</p>';
        return;
      }

      container.innerHTML = savedFields.map((field, index) => `
        <div class="saved-field">
          <button class="delete-btn" onclick="deleteField(${index})">‚úï</button>
          <span class="type-badge ${field.type}">${field.type === 'initials' ? 'INIT' : 'SIGN'}</span>
          <div>Page ${field.page} | x:${field.x}, y:${field.y} | ${field.width}x${field.height}</div>
        </div>
      `).join('');
    }

    // Supprimer un champ
    window.deleteField = function(index) {
      savedFields.splice(index, 1);
      renderSavedFields();
      generateCode();
      renderPage(currentPage);
    }

    // G√©n√©rer le code
    function generateCode() {
      if (savedFields.length === 0) {
        document.getElementById('outputCode').value = '// Clique sur le PDF pour g√©n√©rer le code';
        return;
      }

      const code = `signatureFields = [
${savedFields.map((f, i) => `  { id: "${f.type === 'initials' ? 'init' : 'signature'}_${i + 1}", type: "${f.type}", page: ${f.page}, x: ${f.x}, y: ${f.y}, width: ${f.width}, height: ${f.height} }`).join(',\n')}
];`;

      document.getElementById('outputCode').value = code;
    }

    // Copier le code
    document.getElementById('copyBtn').addEventListener('click', () => {
      const textarea = document.getElementById('outputCode');
      textarea.select();
      document.execCommand('copy');
      alert('Code copi√©!');
    });

    // Changer le type change les dimensions par d√©faut
    document.getElementById('fieldType').addEventListener('change', (e) => {
      if (e.target.value === 'signature') {
        document.getElementById('fieldWidth').value = 180;
        document.getElementById('fieldHeight').value = 40;
      } else {
        document.getElementById('fieldWidth').value = 80;
        document.getElementById('fieldHeight').value = 25;
      }
    });

    // Sauvegarder directement dans SAR
    document.getElementById('saveTemplateBtn').addEventListener('click', async () => {
      if (savedFields.length === 0) {
        alert('‚ùå Aucun champ √† sauvegarder!\n\nClique sur le PDF pour ajouter des champs d\'abord.');
        return;
      }

      const templateName = prompt('üìù Nom du template:', 'Mon Template SAR');
      if (!templateName) return;

      const templateDescription = prompt('üìù Description (optionnel):', '');

      // Convertir les champs au format attendu par l'API
      const formattedFields = savedFields.map((f, i) => ({
        id: `field_${Date.now()}_${i}`,
        type: f.type,
        label: f.type === 'signature' ? 'Signature du client' : 'Initiales du client',
        page: f.page,
        x: f.x,
        y: f.y,
        width: f.width,
        height: f.height
      }));

      const templateData = {
        name: templateName,
        description: templateDescription || '',
        signature_fields: formattedFields
      };

      try {
        const response = await fetch(`${API_BASE_URL}/api/admin/signature-templates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(templateData)
        });

        const data = await response.json();

        if (data.success) {
          alert(`‚úÖ Template "${templateName}" sauvegard√© avec succ√®s!\n\n${savedFields.length} champ(s) enregistr√©(s).\n\nTu peux maintenant l'utiliser dans SAR!`);

          // Demander si on veut ouvrir le dashboard
          if (confirm('üöÄ Ouvrir le dashboard SAR pour utiliser le template?')) {
            window.open(`${API_BASE_URL}/admin/contrats-signature`, '_blank');
          }
        } else {
          alert(`‚ùå Erreur lors de la sauvegarde:\n\n${data.error}`);
        }
      } catch (error) {
        alert(`‚ùå Erreur de connexion:\n\n${error.message}\n\nV√©rifie que le serveur SAR est accessible.`);
      }
    });

    // Ouvrir le dashboard SAR directement
    document.getElementById('openDashboardBtn').addEventListener('click', () => {
      window.open(`${API_BASE_URL}/admin/contrats-signature`, '_blank');
    });
  </script>
</body>
</html>
