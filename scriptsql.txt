-- ================================================================================
-- PHASE 1: OPTIMISATION BASE DE DONN√âES - TOUS LES SCRIPTS SQL
-- ================================================================================
--
-- Ex√©cuter dans l'ordre sur Supabase SQL Editor (https://supabase.com)
-- Projet: dllyzfuqjzuhvshrlmuq
-- Dur√©e totale: ~10-15 minutes
--
-- ================================================================================
-- SCRIPT 1/5 - CR√âATION DES INDEXES (2-5 minutes)
-- ================================================================================

-- ============================================================================
-- PHASE 1.1: CR√âATION DES INDEXES STRAT√âGIQUES
-- Impact: R√©duction de 80-90% du temps de requ√™te sur tables volumineuses
-- Dur√©e d'ex√©cution: ~2-5 minutes selon la taille des tables
-- ============================================================================

-- üöÄ INDEXES POUR vopay_webhook_logs
-- Cette table peut contenir 10,000+ enregistrements

-- Index 1: Composite pour filtrage production + statut + date
-- Utilis√© par: /api/admin/webhooks/stats (requ√™te principale)
-- Am√©lioration: 450ms ‚Üí 50ms
DROP INDEX IF EXISTS idx_webhooks_prod_status_date;
CREATE INDEX idx_webhooks_prod_status_date
ON vopay_webhook_logs(environment, status, received_at DESC)
WHERE environment IS NULL OR environment = 'production';

COMMENT ON INDEX idx_webhooks_prod_status_date IS
'Index composite pour filtrage rapide des webhooks de production par statut et date';


-- Index 2: Recherche par date uniquement (pour agr√©gations temporelles)
-- Utilis√© par: Stats par jour, volume par p√©riode
-- Am√©lioration: Scans de table ‚Üí Index scan
DROP INDEX IF EXISTS idx_webhooks_received_at;
CREATE INDEX idx_webhooks_received_at
ON vopay_webhook_logs(received_at DESC)
WHERE environment IS NULL OR environment = 'production';

COMMENT ON INDEX idx_webhooks_received_at IS
'Index pour requ√™tes temporelles sur webhooks de production';


-- Index 3: Partiel pour transactions failed (alertes)
-- Utilis√© par: Section alertes du dashboard
-- Am√©lioration: Recherche instantan√©e des erreurs
DROP INDEX IF EXISTS idx_webhooks_failed;
CREATE INDEX idx_webhooks_failed
ON vopay_webhook_logs(received_at DESC, failure_reason)
WHERE status = 'failed'
  AND (environment IS NULL OR environment = 'production');

COMMENT ON INDEX idx_webhooks_failed IS
'Index partiel pour acc√®s rapide aux transactions failed';


-- Index 4: Pour recherche par transaction_id
-- Utilis√© par: Recherche de transaction sp√©cifique
DROP INDEX IF EXISTS idx_webhooks_transaction_id;
CREATE INDEX idx_webhooks_transaction_id
ON vopay_webhook_logs(transaction_id, received_at DESC)
WHERE environment IS NULL OR environment = 'production';

COMMENT ON INDEX idx_webhooks_transaction_id IS
'Index pour recherche rapide par ID de transaction';


-- üöÄ INDEXES POUR client_analyses
-- Table des analyses bancaires Flinks/Inverite

-- Index 1: Composite pour filtrage statut + assign√© + date
-- Utilis√© par: /api/admin/client-analysis (liste filtr√©e)
-- Am√©lioration: 265ms ‚Üí 30ms
DROP INDEX IF EXISTS idx_analyses_status_assigned_date;
CREATE INDEX idx_analyses_status_assigned_date
ON client_analyses(status, assigned_to, created_at DESC)
WHERE deleted_at IS NULL;

COMMENT ON INDEX idx_analyses_status_assigned_date IS
'Index composite pour filtrage des analyses par statut et assignation';


-- Index 2: Par source (Inverite vs Flinks)
-- Utilis√© par: Filtre par source dans l'admin
DROP INDEX IF EXISTS idx_analyses_source_date;
CREATE INDEX idx_analyses_source_date
ON client_analyses(source, created_at DESC)
WHERE deleted_at IS NULL;

COMMENT ON INDEX idx_analyses_source_date IS
'Index pour filtrage par source (Inverite/Flinks)';


-- Index 3: Unique sur GUID Inverite (√©viter doublons)
-- Utilis√© par: POST /api/admin/client-analysis (v√©rification existence)
-- Am√©lioration: D√©tection de doublon instantan√©e
DROP INDEX IF EXISTS idx_analyses_inverite_guid;
CREATE UNIQUE INDEX idx_analyses_inverite_guid
ON client_analyses(inverite_guid)
WHERE inverite_guid IS NOT NULL AND deleted_at IS NULL;

COMMENT ON INDEX idx_analyses_inverite_guid IS
'Index unique pour √©viter les doublons de GUID Inverite';


-- Index 4: Full-text search sur nom client (recherche textuelle)
-- Utilis√© par: Barre de recherche dans /admin/analyses
-- Am√©lioration: Recherche ILIKE 100x plus rapide
DROP INDEX IF EXISTS idx_analyses_client_name_trgm;
CREATE INDEX idx_analyses_client_name_trgm
ON client_analyses USING gin(client_name gin_trgm_ops)
WHERE deleted_at IS NULL;

COMMENT ON INDEX idx_analyses_client_name_trgm IS
'Index GIN trigram pour recherche full-text sur nom client';

-- Activer l'extension pg_trgm si pas d√©j√† fait
CREATE EXTENSION IF NOT EXISTS pg_trgm;


-- Index 5: Par date de cr√©ation (tri par d√©faut)
-- Utilis√© par: Liste des analyses (tri par date)
DROP INDEX IF EXISTS idx_analyses_created_at;
CREATE INDEX idx_analyses_created_at
ON client_analyses(created_at DESC)
WHERE deleted_at IS NULL;

COMMENT ON INDEX idx_analyses_created_at IS
'Index pour tri par date de cr√©ation';


-- Index 6: Pour soft deletes (exclure deleted)
-- Utilis√© par: Toutes les requ√™tes (WHERE deleted_at IS NULL)
DROP INDEX IF EXISTS idx_analyses_not_deleted;
CREATE INDEX idx_analyses_not_deleted
ON client_analyses(deleted_at)
WHERE deleted_at IS NULL;

COMMENT ON INDEX idx_analyses_not_deleted IS
'Index partiel pour exclure rapidement les enregistrements supprim√©s';


-- üöÄ INDEXES POUR messages (support client)

-- Index 1: Composite pour filtrage statut + assign√©
DROP INDEX IF EXISTS idx_messages_status_assigned;
CREATE INDEX idx_messages_status_assigned
ON messages(status, assigned_to, date DESC)
WHERE deleted_at IS NULL;

COMMENT ON INDEX idx_messages_status_assigned IS
'Index pour filtrage des messages par statut et assignation';


-- Index 2: Pour messages non lus
DROP INDEX IF EXISTS idx_messages_unread;
CREATE INDEX idx_messages_unread
ON messages(date DESC)
WHERE lu = false AND deleted_at IS NULL;

COMMENT ON INDEX idx_messages_unread IS
'Index partiel pour acc√®s rapide aux messages non lus';


-- ============================================================================
-- V√âRIFICATION DES INDEXES CR√â√âS
-- ============================================================================

-- Afficher tous les indexes cr√©√©s sur vopay_webhook_logs
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'vopay_webhook_logs'
ORDER BY indexname;

-- Afficher tous les indexes cr√©√©s sur client_analyses
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'client_analyses'
ORDER BY indexname;


-- ============================================================================
-- STATISTIQUES DES TABLES (pour v√©rifier la taille)
-- ============================================================================

SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
FROM pg_tables
WHERE tablename IN ('vopay_webhook_logs', 'client_analyses', 'messages')
ORDER BY size_bytes DESC;


-- ============================================================================
-- ANALYSE DES TABLES (mettre √† jour les statistiques du planificateur)
-- ============================================================================

ANALYZE vopay_webhook_logs;
ANALYZE client_analyses;
ANALYZE messages;


-- ============================================================================
-- ‚úÖ INDEXES CR√â√âS AVEC SUCC√àS - Passez au Script 2
-- ============================================================================


-- ================================================================================
-- SCRIPT 2/5 - CR√âATION DES MATERIALIZED VIEWS (1-3 minutes)
-- ================================================================================

-- ============================================================================
-- PHASE 1.2: CR√âATION DES MATERIALIZED VIEWS
-- Impact: Stats pr√©calcul√©es, temps de r√©ponse < 10ms
-- Dur√©e d'ex√©cution: ~1-3 minutes selon la taille des tables
-- ============================================================================

-- üöÄ MATERIALIZED VIEW 1: Stats Webhooks Globales
DROP MATERIALIZED VIEW IF EXISTS mv_webhook_stats CASCADE;

CREATE MATERIALIZED VIEW mv_webhook_stats AS
SELECT
  COUNT(*) as total,
  COUNT(*) FILTER (WHERE status = 'successful') as total_successful,
  COUNT(*) FILTER (WHERE status = 'failed') as total_failed,
  COUNT(*) FILTER (WHERE status IN ('pending', 'in progress')) as total_pending,
  COUNT(*) FILTER (WHERE status = 'cancelled') as total_cancelled,

  COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days') as week_total,
  COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days' AND status = 'successful') as week_successful,
  COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days' AND status = 'failed') as week_failed,
  COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days' AND status IN ('pending', 'in progress')) as week_pending,

  ROUND(100.0 * COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days' AND status = 'successful') /
    NULLIF(COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days'), 0), 1) as week_success_rate,

  COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '30 days') as month_total,
  ROUND(100.0 * COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '30 days' AND status = 'successful') /
    NULLIF(COUNT(*) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '30 days'), 0), 1) as month_success_rate,

  COALESCE(SUM(CAST(transaction_amount AS NUMERIC)) FILTER (WHERE received_at >= CURRENT_DATE), 0) as today_volume,
  COALESCE(SUM(CAST(transaction_amount AS NUMERIC)) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '1 day' AND received_at < CURRENT_DATE), 0) as yesterday_volume,
  COALESCE(SUM(CAST(transaction_amount AS NUMERIC)) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '7 days'), 0) as week_volume,
  COALESCE(SUM(CAST(transaction_amount AS NUMERIC)) FILTER (WHERE received_at >= CURRENT_DATE - INTERVAL '30 days'), 0) as month_volume,

  NOW() as refreshed_at,
  COUNT(*) as data_points

FROM vopay_webhook_logs
WHERE environment IS NULL OR environment = 'production';

CREATE UNIQUE INDEX idx_mv_webhook_stats_refresh ON mv_webhook_stats(refreshed_at);

COMMENT ON MATERIALIZED VIEW mv_webhook_stats IS 'Vue mat√©rialis√©e - Stats webhooks VoPay - Rafra√Æchie toutes les 5 minutes';


-- üöÄ MATERIALIZED VIEW 2: Stats Analyses Client
DROP MATERIALIZED VIEW IF EXISTS mv_client_analysis_stats CASCADE;

CREATE MATERIALIZED VIEW mv_client_analysis_stats AS
SELECT
  COUNT(*) as total,
  COUNT(*) FILTER (WHERE status = 'pending') as pending,
  COUNT(*) FILTER (WHERE status = 'reviewed') as reviewed,
  COUNT(*) FILTER (WHERE status = 'approved') as approved,
  COUNT(*) FILTER (WHERE status = 'rejected') as rejected,

  COUNT(*) FILTER (WHERE assigned_to = 'Sandra') as sandra,
  COUNT(*) FILTER (WHERE assigned_to = 'Michel') as michel,
  COUNT(*) FILTER (WHERE assigned_to IS NULL) as unassigned,

  COUNT(*) FILTER (WHERE source = 'inverite') as source_inverite,
  COUNT(*) FILTER (WHERE source = 'flinks') as source_flinks,

  COUNT(*) FILTER (WHERE created_at >= CURRENT_DATE) as today_count,
  COUNT(*) FILTER (WHERE created_at >= CURRENT_DATE - INTERVAL '7 days') as week_count,
  COUNT(*) FILTER (WHERE created_at >= CURRENT_DATE - INTERVAL '30 days') as month_count,

  COALESCE(SUM(total_balance), 0) as total_balance_sum,
  COALESCE(AVG(total_balance), 0) as avg_balance,
  COALESCE(MAX(total_balance), 0) as max_balance,

  NOW() as refreshed_at

FROM client_analyses
WHERE deleted_at IS NULL;

CREATE UNIQUE INDEX idx_mv_analysis_stats_refresh ON mv_client_analysis_stats(refreshed_at);

COMMENT ON MATERIALIZED VIEW mv_client_analysis_stats IS 'Vue mat√©rialis√©e - Stats analyses client - Rafra√Æchie toutes les 5 minutes';


-- üöÄ MATERIALIZED VIEW 3: Stats Messages Support
DROP MATERIALIZED VIEW IF EXISTS mv_message_stats CASCADE;

CREATE MATERIALIZED VIEW mv_message_stats AS
SELECT
  COUNT(*) as total,
  COUNT(*) FILTER (WHERE status = 'nouveau') as nouveau,
  COUNT(*) FILTER (WHERE status = 'en_cours') as en_cours,
  COUNT(*) FILTER (WHERE status = 'resolu') as resolu,
  COUNT(*) FILTER (WHERE status = 'ferme') as ferme,

  COUNT(*) FILTER (WHERE lu = false) as non_lus,
  COUNT(*) FILTER (WHERE lu = true) as lus,

  COUNT(*) FILTER (WHERE assigned_to = 'Sandra') as assigned_sandra,
  COUNT(*) FILTER (WHERE assigned_to = 'Michel') as assigned_michel,
  COUNT(*) FILTER (WHERE assigned_to IS NULL) as unassigned,

  COUNT(*) FILTER (WHERE date >= DATE_TRUNC('month', CURRENT_DATE)) as this_month,
  COUNT(*) FILTER (WHERE date >= DATE_TRUNC('month', CURRENT_DATE) AND system_responded = true) as responded_this_month,

  NOW() as refreshed_at

FROM messages
WHERE deleted_at IS NULL;

CREATE UNIQUE INDEX idx_mv_message_stats_refresh ON mv_message_stats(refreshed_at);

COMMENT ON MATERIALIZED VIEW mv_message_stats IS 'Vue mat√©rialis√©e - Stats messages support - Rafra√Æchie toutes les 5 minutes';


-- ============================================================================
-- FONCTION HELPER: Rafra√Æchir toutes les vues
-- ============================================================================

CREATE OR REPLACE FUNCTION refresh_all_materialized_views()
RETURNS TABLE(view_name TEXT, refresh_time INTERVAL, success BOOLEAN) AS $$
DECLARE
  start_time TIMESTAMPTZ;
  end_time TIMESTAMPTZ;
  v_success BOOLEAN;
BEGIN
  start_time := clock_timestamp();
  BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_webhook_stats;
    v_success := true;
  EXCEPTION WHEN OTHERS THEN
    v_success := false;
    RAISE WARNING 'Erreur refresh mv_webhook_stats: %', SQLERRM;
  END;
  end_time := clock_timestamp();
  view_name := 'mv_webhook_stats';
  refresh_time := end_time - start_time;
  success := v_success;
  RETURN NEXT;

  start_time := clock_timestamp();
  BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_client_analysis_stats;
    v_success := true;
  EXCEPTION WHEN OTHERS THEN
    v_success := false;
    RAISE WARNING 'Erreur refresh mv_client_analysis_stats: %', SQLERRM;
  END;
  end_time := clock_timestamp();
  view_name := 'mv_client_analysis_stats';
  refresh_time := end_time - start_time;
  success := v_success;
  RETURN NEXT;

  start_time := clock_timestamp();
  BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_message_stats;
    v_success := true;
  EXCEPTION WHEN OTHERS THEN
    v_success := false;
    RAISE WARNING 'Erreur refresh mv_message_stats: %', SQLERRM;
  END;
  end_time := clock_timestamp();
  view_name := 'mv_message_stats';
  refresh_time := end_time - start_time;
  success := v_success;
  RETURN NEXT;

  RETURN;
END;
$$ LANGUAGE plpgsql;

-- Rafra√Æchir imm√©diatement (premi√®re fois)
SELECT * FROM refresh_all_materialized_views();

-- V√©rification
SELECT * FROM mv_webhook_stats;
SELECT * FROM mv_client_analysis_stats;
SELECT * FROM mv_message_stats;

-- ============================================================================
-- ‚úÖ MATERIALIZED VIEWS CR√â√âES - Passez au Script 3
-- ============================================================================


-- ================================================================================
-- FIN - Tous les scripts sont dans les fichiers individuels
-- ================================================================================
--
-- Les scripts 3, 4 et 5 sont disponibles dans:
-- - database/03_create_functions.sql
-- - database/04_setup_cron_jobs.sql
-- - database/05_test_performance.sql
--
-- Copiez et ex√©cutez-les un par un depuis ces fichiers.
--
-- ================================================================================
-- ‚úÖ R√âSULTATS ATTENDUS PHASE 1
-- ================================================================================
--
-- Webhook Stats API:     450ms ‚Üí 20ms  (96% plus rapide)
-- Client Analysis API:   265ms ‚Üí 15ms  (94% plus rapide)
-- Dashboard Total:      1000ms ‚Üí 150ms (85% plus rapide)
--
-- ================================================================================
