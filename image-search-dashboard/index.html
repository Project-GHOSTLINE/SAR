<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Image Search Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EğŸ¯%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }

        /* Sidebar */
        .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 280px; background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%); transition: all 0.3s; z-index: 1000; overflow-y: auto; }
        .sidebar.collapsed { width: 80px; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo { font-size: 1.5rem; font-weight: bold; color: white; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar.collapsed .logo-text { display: none; }

        /* Menu Items */
        .menu-item { padding: 1rem 1.5rem; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem; border-left: 3px solid transparent; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(59,130,246,0.2); color: white; border-left-color: #3b82f6; }
        .menu-icon { font-size: 1.5rem; min-width: 24px; text-align: center; }
        .sidebar.collapsed .menu-text { display: none; }

        /* Main Content */
        .main-content { margin-left: 280px; min-height: 100vh; background: #0f172a; transition: all 0.3s; }
        .sidebar.collapsed + .main-content { margin-left: 80px; }

        /* Page Sections */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; padding: 1.5rem; color: white; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-4px); }

        /* Image Grid */
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .image-card { position: relative; overflow: hidden; border-radius: 0.75rem; aspect-ratio: 1; cursor: pointer; transition: all 0.3s; background: #1e293b; }
        .image-card:hover { transform: scale(1.05); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .image-card img { width: 100%; height: 100%; object-fit: cover; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 1rem; }

        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; }

        /* Input */
        .input { background: #1e293b; border: 2px solid #334155; border-radius: 0.5rem; padding: 0.75rem 1rem; color: white; width: 100%; transition: all 0.2s; }
        .input:focus { outline: none; border-color: #667eea; background: #0f172a; }

        /* Toggle */
        .toggle-btn { position: fixed; top: 1rem; left: 1rem; z-index: 1001; background: #667eea; color: white; width: 48px; height: 48px; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #764ba2; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Toggle Button -->
    <div class="toggle-btn" onclick="toggleSidebar()">â˜°</div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>ğŸ¯</span>
                <span class="logo-text">Image Search</span>
            </div>
        </div>

        <div class="menu-item active" onclick="showPage('dashboard')">
            <span class="menu-icon">ğŸ“Š</span>
            <span class="menu-text">Dashboard</span>
        </div>

        <div class="menu-item" onclick="showPage('search')">
            <span class="menu-icon">ğŸ”</span>
            <span class="menu-text">Rechercher</span>
        </div>

        <div class="menu-item" onclick="showPage('gallery')">
            <span class="menu-icon">ğŸ–¼ï¸</span>
            <span class="menu-text">Galerie</span>
        </div>

        <div class="menu-item" onclick="showPage('scraper')">
            <span class="menu-icon">ğŸ•·ï¸</span>
            <span class="menu-text">Scraper</span>
        </div>

        <div class="menu-item" onclick="showPage('scanner')">
            <span class="menu-icon">ğŸ‘¤</span>
            <span class="menu-text">Scanner</span>
        </div>

        <div class="menu-item" onclick="showPage('settings')">
            <span class="menu-icon">âš™ï¸</span>
            <span class="menu-text">ParamÃ¨tres</span>
        </div>

        <div style="margin-top: auto; padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem;" class="menu-text">
                <div>v1.0.0</div>
                <div>Â© 2026 Claude Code</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page active" style="padding: 2rem;">
            <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Dashboard Overview
            </h1>

            <!-- Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="stat-card">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ğŸ“ Images Totales</div>
                    <div style="font-size: 2.5rem; font-weight: bold;" id="stat-total">0</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">Dans scraped_images/</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ğŸ‘¤ Visages IndexÃ©s</div>
                    <div style="font-size: 2.5rem; font-weight: bold;" id="stat-faces">0</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">PrÃªts pour recherche</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ğŸ“¦ Images IndexÃ©es</div>
                    <div style="font-size: 2.5rem; font-weight: bold;" id="stat-indexed">0</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">Avec visages dÃ©tectÃ©s</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">ğŸ’¾ Taille Totale</div>
                    <div style="font-size: 2.5rem; font-weight: bold;" id="stat-size">0 MB</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">Stockage utilisÃ©</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="background: #1e293b; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem;">ğŸš€ Actions Rapides</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="showPage('scraper')">ğŸ•·ï¸ Scraper Images</button>
                    <button class="btn btn-success" onclick="showPage('scanner')">ğŸ‘¤ Scanner Visages</button>
                    <button class="btn btn-primary" onclick="showPage('search')">ğŸ” Rechercher</button>
                    <button class="btn btn-success" onclick="showPage('gallery')">ğŸ–¼ï¸ Voir Galerie</button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div style="background: #1e293b; border-radius: 1rem; padding: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem;">ğŸ“‹ ActivitÃ© RÃ©cente</h2>
                <div id="recent-activity" style="color: #94a3b8;"></div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="page-search" class="page" style="padding: 2rem;">
            <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 2rem;">ğŸ” Recherche d'Images</h1>

            <div style="background: #1e293b; border-radius: 1rem; padding: 2rem; max-width: 800px;">
                <p style="color: #94a3b8; margin-bottom: 2rem;">Upload une photo pour trouver des images similaires dans ta collection</p>

                <input type="file" id="searchImage" accept="image/*" class="input" style="margin-bottom: 1.5rem;">

                <button class="btn btn-primary" onclick="searchImage()" style="width: 100%;">
                    ğŸš€ Lancer la Recherche
                </button>

                <div id="searchResults" style="margin-top: 2rem;"></div>
            </div>
        </div>

        <!-- Gallery Page -->
        <div id="page-gallery" class="page" style="padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: bold;">ğŸ–¼ï¸ Galerie d'Images</h1>
                <button class="btn btn-primary" onclick="loadGallery()">ğŸ”„ Recharger</button>
            </div>

            <!-- Search Bar -->
            <div style="background: #1e293b; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                    <div style="position: relative;">
                        <input type="text" id="gallerySearch" class="input" placeholder="ğŸ” Rechercher par nom, tags, commentaire, localisation..."
                               oninput="filterGalleryAdvanced()"
                               style="padding-left: 3rem;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.25rem;">ğŸ”</span>
                    </div>
                    <button class="btn btn-primary" onclick="toggleAdvancedSearch()">âš™ï¸ Filtres</button>
                </div>

                <!-- Advanced Filters -->
                <div id="advancedFilters" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #94a3b8;">ğŸ“ Localisation GPS</label>
                            <select id="filterGPS" class="input" onchange="filterGalleryAdvanced()">
                                <option value="">Toutes</option>
                                <option value="has_gps">Avec GPS</option>
                                <option value="no_gps">Sans GPS</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #94a3b8;">â­ Note minimale</label>
                            <select id="filterRating" class="input" onchange="filterGalleryAdvanced()">
                                <option value="0">Toutes</option>
                                <option value="1">â­ 1+</option>
                                <option value="2">â­ 2+</option>
                                <option value="3">â­ 3+</option>
                                <option value="4">â­ 4+</option>
                                <option value="5">â­ 5</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #94a3b8;">ğŸ“‚ CatÃ©gorie</label>
                            <select id="filterCategory" class="input" onchange="filterGalleryAdvanced()">
                                <option value="">Toutes</option>
                                <option value="portrait">Portrait</option>
                                <option value="landscape">Paysage</option>
                                <option value="document">Document</option>
                                <option value="screenshot">Screenshot</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #94a3b8;">â¤ï¸ Favoris</label>
                            <select id="filterFavorite" class="input" onchange="filterGalleryAdvanced()">
                                <option value="">Tous</option>
                                <option value="1">Favoris seulement</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Search Quebec/Canada -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155;">
                    <label style="display: block; margin-bottom: 0.75rem; font-size: 0.875rem; color: #94a3b8; font-weight: 600;">ğŸ‡¨ğŸ‡¦ Recherches Rapides - QuÃ©bec & Canada</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button class="btn" onclick="quickSearch('quebec')" style="background: #dc2626; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ QuÃ©bec
                        </button>
                        <button class="btn" onclick="quickSearch('montreal')" style="background: #2563eb; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ™ï¸ MontrÃ©al
                        </button>
                        <button class="btn" onclick="quickSearch('laval')" style="background: #7c3aed; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ“ Laval
                        </button>
                        <button class="btn" onclick="quickSearch('longueuil')" style="background: #db2777; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ“ Longueuil
                        </button>
                        <button class="btn" onclick="quickSearch('gatineau')" style="background: #059669; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ“ Gatineau
                        </button>
                        <button class="btn" onclick="quickSearch('sherbrooke')" style="background: #ea580c; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ“ Sherbrooke
                        </button>
                        <button class="btn" onclick="quickSearch('canada')" style="background: #dc2626; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ‡¨ğŸ‡¦ Canada
                        </button>
                        <button class="btn" onclick="quickSearch('canadienne')" style="background: #dc2626; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ‘© Canadienne
                        </button>
                        <button class="btn" onclick="quickSearch('quebecoise')" style="background: #dc2626; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸ‘© QuÃ©bÃ©coise
                        </button>
                        <button class="btn" onclick="quickSearch('.ca')" style="background: #475569; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ğŸŒ Sites .CA
                        </button>
                    </div>
                </div>

                <div id="searchStats" style="margin-top: 1rem; color: #94a3b8; font-size: 0.875rem;"></div>
            </div>

            <div id="galleryGrid" class="image-grid"></div>
        </div>

        <!-- Scraper Page -->
        <div id="page-scraper" class="page" style="padding: 2rem;">
            <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 2rem;">ğŸ•·ï¸ Scraper Web</h1>

            <div style="background: #1e293b; border-radius: 1rem; padding: 2rem; max-width: 800px;">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">URL du Site</label>
                    <input type="text" id="scrapeUrl" class="input" placeholder="https://example.com">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Pages Max</label>
                        <input type="number" id="scrapePages" class="input" value="100" min="1" max="500">
                        <small style="color: #94a3b8; font-size: 0.75rem;">RecommandÃ©: 50-100</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Images Max</label>
                        <input type="number" id="scrapeImages" class="input" value="1000" min="1" max="5000">
                        <small style="color: #94a3b8; font-size: 0.75rem;">RecommandÃ©: 500-1000</small>
                    </div>
                </div>

                <button class="btn btn-success" onclick="startScraping()" style="width: 100%;">
                    ğŸš€ Commencer le Scraping
                </button>

                <div id="scrapeResults" style="margin-top: 2rem; display: none;">
                    <!-- Progress Bar -->
                    <div style="background: #0f172a; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; color: #38ef7d;">ğŸ“Š Progression</span>
                            <span id="progressPercent" style="font-weight: 600; color: #667eea;">0%</span>
                        </div>
                        <div style="background: #334155; height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; font-size: 0.875rem;">
                            <div>
                                <span style="color: #94a3b8;">ğŸ“„ Pages:</span>
                                <span id="statsPages" style="color: white; font-weight: 600; margin-left: 0.5rem;">0/0</span>
                            </div>
                            <div>
                                <span style="color: #94a3b8;">ğŸ–¼ï¸ Images:</span>
                                <span id="statsImages" style="color: white; font-weight: 600; margin-left: 0.5rem;">0/0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div style="background: #0f172a; border-radius: 0.5rem; padding: 1.5rem; font-family: monospace; font-size: 0.875rem;" id="scrapeProgress"></div>
                </div>
            </div>
        </div>

        <!-- Scanner Page -->
        <div id="page-scanner" class="page" style="padding: 2rem;">
            <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 2rem;">ğŸ‘¤ Scanner de Visages</h1>

            <div style="background: #1e293b; border-radius: 1rem; padding: 2rem; max-width: 800px;">
                <p style="color: #94a3b8; margin-bottom: 2rem;">Scan automatique des visages dans toutes tes images</p>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Dossier Ã  Scanner</label>
                    <input type="text" id="scanPath" class="input" value="/Users/xunit/Desktop/ğŸ“ Projets/sar/image-search-dashboard/scraped_images">
                </div>

                <button class="btn btn-primary" onclick="startScanning()" style="width: 100%;">
                    ğŸš€ Scanner Maintenant
                </button>

                <div id="scanResults" style="margin-top: 2rem; display: none;">
                    <div style="background: #0f172a; border-radius: 0.5rem; padding: 1.5rem; font-family: monospace; font-size: 0.875rem;" id="scanProgress"></div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page" style="padding: 2rem;">
            <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 2rem;">âš™ï¸ ParamÃ¨tres</h1>

            <div style="max-width: 800px;">
                <div style="background: #1e293b; border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">ğŸ—„ï¸ Base de DonnÃ©es</h3>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">GÃ©rer les donnÃ©es stockÃ©es localement</p>
                    <button class="btn btn-danger" onclick="clearDatabase()">ğŸ—‘ï¸ Effacer Toutes les DonnÃ©es</button>
                </div>

                <div style="background: #1e293b; border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">ğŸ”— Liens Utiles</h3>
                    <div style="display: grid; gap: 1rem;">
                        <a href="http://localhost:8000" target="_blank" class="btn btn-primary" style="text-decoration: none; text-align: center;">
                            ğŸ‘¤ Face Search API
                        </a>
                        <a href="http://localhost:8000" target="_blank" class="btn btn-primary" style="text-decoration: none; text-align: center;">
                            ğŸ•·ï¸ Scraper API
                        </a>
                        <button class="btn btn-success" onclick="openFolder()">ğŸ“ Ouvrir Dossier Images</button>
                    </div>
                </div>

                <div style="background: #1e293b; border-radius: 1rem; padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">â„¹ï¸ Ã€ Propos</h3>
                    <div style="color: #94a3b8; line-height: 1.8;">
                        <p><strong>Version:</strong> 1.0.0</p>
                        <p><strong>CrÃ©Ã© par:</strong> Claude Code</p>
                        <p><strong>Date:</strong> 2026-01-31</p>
                        <p><strong>Technologies:</strong> Flask, OpenCV, SQLite, Tailwind CSS</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" onclick="if(event.target.id === 'modal') closeModal()">
        <img id="modalImage" src="" alt="Full size" style="transition: transform 0.3s; cursor: zoom-in;" onclick="event.stopPropagation()">

        <!-- Close Button -->
        <button onclick="closeModal()" style="position: absolute; top: 2rem; right: 2rem; width: 56px; height: 56px; border-radius: 1rem; background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; border: none; cursor: pointer; font-size: 1.5rem; font-weight: bold; z-index: 10;">
            âœ•
        </button>

        <!-- Zoom Controls -->
        <div style="position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); display: flex; gap: 1rem; background: rgba(0,0,0,0.8); padding: 1rem; border-radius: 1rem; backdrop-filter: blur(10px);">
            <button onclick="zoomOut(); event.stopPropagation();" class="btn" style="width: 56px; height: 56px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.5rem; border-radius: 0.75rem;">
                â–
            </button>
            <button onclick="resetZoom(); event.stopPropagation();" class="btn" style="width: 56px; height: 56px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); font-size: 1.25rem; border-radius: 0.75rem;">
                â†»
            </button>
            <button onclick="zoomIn(); event.stopPropagation();" class="btn" style="width: 56px; height: 56px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); font-size: 1.5rem; border-radius: 0.75rem;">
                â•
            </button>
        </div>

        <!-- Image Info -->
        <div id="imageInfo" style="position: absolute; top: 2rem; left: 2rem; background: rgba(0,0,0,0.8); padding: 1rem 1.5rem; border-radius: 1rem; backdrop-filter: blur(10px); max-width: 400px;">
            <div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">Chargement...</div>
        </div>
    </div>

    <script>
        // Initialize
        loadAllStats();
        setInterval(loadAllStats, 5000);

        // Global variable to store all images
        let allGalleryImages = [];
        let allImageMetadata = {};

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            event.currentTarget.classList.add('active');

            if (pageName === 'gallery') loadGallery();
        }

        async function loadAllStats() {
            try {
                const scrapeRes = await fetch('http://localhost:8000/api/stats');
                const data = await scrapeRes.json();

                document.getElementById('stat-total').textContent = data.images_count || 0;
                document.getElementById('stat-size').textContent = '0 MB';  // Placeholder
                document.getElementById('stat-faces').textContent = data.total_faces || 0;
                document.getElementById('stat-indexed').textContent = data.total_images || 0;

                // Recent activity - get from face API
                try {
                    const faceRes = await fetch('http://localhost:8000/api/face-stats');
                    const faceData = await faceRes.json();

                    if (faceData.recent && faceData.recent.length > 0) {
                        const recentHtml = faceData.recent.slice(0, 5).map(item => `
                            <div style="padding: 1rem; background: #0f172a; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>ğŸ“¸ ${item.filename}</span>
                                    <span>${item.faces} visage(s)</span>
                                </div>
                            </div>
                        `).join('');
                        document.getElementById('recent-activity').innerHTML = recentHtml;
                    }
                } catch (err) {
                    console.error('Error loading recent activity:', err);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function searchImage() {
            const fileInput = document.getElementById('searchImage');
            if (!fileInput.files.length) {
                alert('Choisissez une image d\'abord');
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            document.getElementById('searchResults').innerHTML = '<div style="text-align: center; padding: 3rem; color: #667eea; font-size: 1.25rem;">â³ Recherche en cours...</div>';

            try {
                const response = await fetch('http://localhost:8000/api/search', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    document.getElementById('searchResults').innerHTML = `<div style="text-align: center; padding: 2rem; color: #f5576c;">âŒ ${data.error}</div>`;
                } else if (data.matches_found === 0) {
                    document.getElementById('searchResults').innerHTML = '<div style="text-align: center; padding: 2rem; color: #fbbf24;">ğŸ˜• Aucun match trouvÃ©</div>';
                } else {
                    let html = `<h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; color: #38ef7d;">âœ… ${data.matches_found} match(s) trouvÃ©(s)</h3>`;
                    html += '<div class="image-grid">';

                    data.matches.forEach(match => {
                        html += `
                            <div class="image-card">
                                <img src="http://localhost:8000/api/image/${encodeURIComponent(match.path)}"
                                     onclick="openModal('http://localhost:8000/api/image/${encodeURIComponent(match.path)}')"
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%231e293b%22 width=%22200%22 height=%22200%22/%3E%3C/svg%3E'">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 0.75rem; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);">
                                    <div style="font-size: 1rem; font-weight: bold; color: #38ef7d;">${match.similarity.toFixed(1)}%</div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    document.getElementById('searchResults').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('searchResults').innerHTML = `<div style="text-align: center; padding: 2rem; color: #f5576c;">âŒ ${error.message}</div>`;
            }
        }

        async function loadGallery() {
            document.getElementById('galleryGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #667eea; font-size: 1.25rem;">â³ Chargement...</div>';

            try {
                const response = await fetch('http://localhost:8000/api/list-images');
                const data = await response.json();

                if (data.images.length === 0) {
                    document.getElementById('galleryGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94a3b8;">ğŸ“­ Aucune image. Lance un scraping!</div>';
                    allGalleryImages = [];
                    return;
                }

                // Store all images globally
                allGalleryImages = data.images;

                // Load metadata for all images
                await loadAllMetadata();

                // Reset search
                document.getElementById('gallerySearch').value = '';

                // Display images
                displayGalleryImages(allGalleryImages.slice(0, 500));

            } catch (error) {
                document.getElementById('galleryGrid').innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #f5576c;">âŒ ${error.message}</div>`;
            }
        }

        async function loadAllMetadata() {
            // Load metadata for all images from the API
            try {
                const response = await fetch('http://localhost:8000/api/all-metadata?limit=5000');
                const data = await response.json();

                // Store metadata indexed by filename
                allImageMetadata = {};
                if (data.results) {
                    data.results.forEach(meta => {
                        allImageMetadata[meta.hash_filename] = meta;
                    });
                }
            } catch (error) {
                console.error('Error loading metadata:', error);
            }
        }

        function displayGalleryImages(images) {
            if (images.length === 0) {
                document.getElementById('galleryGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94a3b8;">ğŸ˜• Aucune image trouvÃ©e</div>';
                return;
            }

            let html = '';
            images.forEach(img => {
                const meta = allImageMetadata[img] || {};

                // Build badges
                let badges = '';
                if (meta.gps_latitude) {
                    badges += '<span style="background: #10b981; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; margin-right: 0.25rem;">ğŸ“ GPS</span>';
                }
                if (meta.rating && meta.rating > 0) {
                    badges += `<span style="background: #f59e0b; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; margin-right: 0.25rem;">â­ ${meta.rating}</span>`;
                }
                if (meta.is_favorite) {
                    badges += '<span style="background: #ef4444; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; margin-right: 0.25rem;">â¤ï¸</span>';
                }
                if (meta.user_tags) {
                    badges += '<span style="background: #3b82f6; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; margin-right: 0.25rem;">ğŸ·ï¸</span>';
                }

                html += `
                    <div class="image-card" style="position: relative;">
                        <img src="http://localhost:8000/scraped_images/${img}"
                             onclick="openModal('http://localhost:8000/scraped_images/${img}', '${img}')"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%231e293b%22 width=%22200%22 height=%22200%22/%3E%3C/svg%3E'">

                        ${badges ? `<div style="position: absolute; top: 0.5rem; left: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">${badges}</div>` : ''}

                        <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 0.5rem; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); opacity: 0; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
                            ${meta.gps_location ? `<div style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 0.35rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ğŸ“ ${meta.gps_location}</div>` : ''}
                            <button onclick="event.stopPropagation(); openOSINT('${img}', 'http://localhost:8000/scraped_images/${img}')" style="width: 100%; padding: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 0.75rem;">
                                ğŸ” OSINT
                            </button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('galleryGrid').innerHTML = html;
        }

        function toggleAdvancedSearch() {
            const filters = document.getElementById('advancedFilters');
            filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
        }

        function filterGalleryAdvanced() {
            const searchTerm = document.getElementById('gallerySearch').value.toLowerCase().trim();
            const filterGPS = document.getElementById('filterGPS').value;
            const filterRating = parseInt(document.getElementById('filterRating').value) || 0;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterFavorite = document.getElementById('filterFavorite').value;

            let filtered = allGalleryImages.filter(img => {
                // Get metadata for this image
                const meta = allImageMetadata[img] || {};

                // Text search (filename, tags, comment, location)
                if (searchTerm !== '') {
                    const searchableText = [
                        img,
                        meta.user_tags || '',
                        meta.user_comment || '',
                        meta.gps_location || '',
                        meta.original_filename || '',
                        meta.original_url || ''
                    ].join(' ').toLowerCase();

                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }

                // GPS filter
                if (filterGPS === 'has_gps' && !meta.gps_latitude) return false;
                if (filterGPS === 'no_gps' && meta.gps_latitude) return false;

                // Rating filter
                if (filterRating > 0 && (meta.rating || 0) < filterRating) return false;

                // Category filter
                if (filterCategory && meta.category !== filterCategory) return false;

                // Favorite filter
                if (filterFavorite === '1' && !meta.is_favorite) return false;

                return true;
            });

            // Display filtered results
            displayGalleryImages(filtered.slice(0, 500));

            // Update stats
            if (searchTerm === '' && !filterGPS && filterRating === 0 && !filterCategory && !filterFavorite) {
                document.getElementById('searchStats').textContent = `${allGalleryImages.length} images au total`;
            } else {
                document.getElementById('searchStats').innerHTML = `
                    <span style="color: #38ef7d; font-weight: 600;">${filtered.length}</span>
                    image(s) trouvÃ©e(s) sur ${allGalleryImages.length} au total
                `;
            }
        }

        function filterGallery() {
            filterGalleryAdvanced();
        }

        function quickSearch(term) {
            // Set search term
            document.getElementById('gallerySearch').value = term;

            // Reset filters
            document.getElementById('filterGPS').value = '';
            document.getElementById('filterRating').value = '0';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterFavorite').value = '';

            // Execute search
            filterGalleryAdvanced();

            // Scroll to results
            document.getElementById('galleryGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function startScraping() {
            const url = document.getElementById('scrapeUrl').value;
            const maxPages = parseInt(document.getElementById('scrapePages').value);
            const maxImages = parseInt(document.getElementById('scrapeImages').value);

            if (!url) {
                alert('Entre une URL');
                return;
            }

            document.getElementById('scrapeResults').style.display = 'block';
            document.getElementById('scrapeProgress').innerHTML = 'â³ Initialisation du scraping avec Selenium...';

            // Reset progress bar
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('statsPages').textContent = '0/' + maxPages;
            document.getElementById('statsImages').textContent = '0/' + maxImages;

            // Start progress monitoring
            const startTime = Date.now();
            let progressInterval = setInterval(async () => {
                try {
                    const stats = await fetch('http://localhost:8000/api/stats').then(r => r.json());
                    const currentImages = stats.images_count || 0;
                    const progress = Math.min(Math.round((currentImages / maxImages) * 100), 99);

                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressPercent').textContent = progress + '%';
                    document.getElementById('statsImages').textContent = currentImages + '/' + maxImages;
                    document.getElementById('progressBar').textContent = currentImages + ' images';

                    // Estimate pages based on time
                    const elapsed = Math.floor((Date.now() - startTime) / 2000);
                    const estimatedPages = Math.min(elapsed, maxPages);
                    document.getElementById('statsPages').textContent = estimatedPages + '/' + maxPages;
                } catch (e) {
                    console.error('Progress update error:', e);
                }
            }, 1000);

            try {
                const response = await fetch('http://localhost:8000/api/scrape-selenium', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, max_pages: maxPages, max_images: maxImages, screenshots: true })
                });

                clearInterval(progressInterval);
                const data = await response.json();

                // Final progress update
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressPercent').textContent = '100%';
                document.getElementById('progressBar').textContent = 'âœ… TerminÃ©!';
                document.getElementById('statsPages').textContent = data.pages_visited + '/' + maxPages;
                document.getElementById('statsImages').textContent = data.downloaded + '/' + maxImages;

                if (data.error) {
                    document.getElementById('scrapeProgress').innerHTML = `âŒ ${data.error}`;
                } else {
                    document.getElementById('scrapeProgress').innerHTML = `
                        âœ… Scraping TerminÃ©!<br><br>
                        ğŸ“„ Pages visitÃ©es: ${data.pages_visited}<br>
                        ğŸ–¼ï¸ Images tÃ©lÃ©chargÃ©es: ${data.downloaded}<br>
                        ğŸ“¸ Screenshots: ${data.screenshots}<br>
                        ${data.errors.length > 0 ? `âš ï¸ Erreurs: ${data.errors.length}` : ''}
                    `;
                    loadAllStats();
                    setTimeout(() => {
                        alert('âœ… Scraping terminÃ©! Allez dans la Galerie pour voir les images.');
                    }, 500);
                }
            } catch (error) {
                clearInterval(progressInterval);
                document.getElementById('scrapeProgress').innerHTML = `âŒ ${error.message}`;
                document.getElementById('progressBar').style.background = '#ef4444';
            }
        }

        async function startScanning() {
            const path = document.getElementById('scanPath').value;
            document.getElementById('scanResults').style.display = 'block';
            document.getElementById('scanProgress').innerHTML = 'â³ Scan en cours...';

            try {
                const response = await fetch('http://localhost:8000/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ directory: path })
                });

                const data = await response.json();

                if (data.error) {
                    document.getElementById('scanProgress').innerHTML = `âŒ ${data.error}`;
                } else {
                    document.getElementById('scanProgress').innerHTML = `
                        âœ… TerminÃ©!<br><br>
                        ğŸ“Š Images: ${data.processed}<br>
                        ğŸ‘¤ Visages: ${data.faces_found}
                    `;
                    loadAllStats();
                }
            } catch (error) {
                document.getElementById('scanProgress').innerHTML = `âŒ ${error.message}`;
            }
        }

        let currentZoom = 1;

        function openModal(src, filename = '') {
            currentZoom = 1;
            const img = document.getElementById('modalImage');
            img.src = src;
            img.style.transform = 'scale(1)';
            document.getElementById('modal').classList.add('active');

            // Load metadata if filename provided
            if (filename) {
                loadImageMetadata(filename);
            } else {
                document.getElementById('imageInfo').innerHTML = '<div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">ğŸ“¸ Image</div>';
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentZoom = 1;
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 3);
            document.getElementById('modalImage').style.transform = `scale(${currentZoom})`;
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.5);
            document.getElementById('modalImage').style.transform = `scale(${currentZoom})`;
        }

        function resetZoom() {
            currentZoom = 1;
            document.getElementById('modalImage').style.transform = 'scale(1)';
        }

        async function loadImageMetadata(filename) {
            try {
                const response = await fetch(`http://localhost:8000/api/get-metadata/${filename}`);
                if (response.ok) {
                    const data = await response.json();
                    let html = `
                        <div style="font-size: 1rem; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“¸ ${data.original_filename || filename}</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7); line-height: 1.6;">
                            ğŸ“ ${data.width}x${data.height} ${data.format}<br>
                            ğŸ’¾ ${(data.file_size / 1024).toFixed(1)} KB
                    `;

                    if (data.gps_location) {
                        html += `<br>ğŸ“ ${data.gps_location}`;
                    }

                    if (data.camera_make) {
                        html += `<br>ğŸ“· ${data.camera_make} ${data.camera_model || ''}`;
                    }

                    if (data.taken_at) {
                        html += `<br>ğŸ“… ${data.taken_at}`;
                    }

                    if (data.original_url && data.original_url !== 'unknown') {
                        html += `<br>ğŸ”— <a href="${data.original_url}" target="_blank" style="color: #38ef7d; text-decoration: underline;">Source</a>`;
                    }

                    if (data.profile_url) {
                        html += `<br>ğŸ‘¤ <a href="${data.profile_url}" target="_blank" style="color: #4facfe; text-decoration: underline; font-weight: bold;">Voir Profil</a>`;
                    }

                    if (data.user_tags) {
                        html += `<br>ğŸ·ï¸ ${data.user_tags}`;
                    }

                    if (data.user_comment) {
                        html += `<br>ğŸ’¬ ${data.user_comment}`;
                    }

                    if (data.rating > 0) {
                        html += `<br>â­ ${'â˜…'.repeat(data.rating)}${'â˜†'.repeat(5-data.rating)}`;
                    }

                    html += '</div>';
                    document.getElementById('imageInfo').innerHTML = html;
                } else {
                    document.getElementById('imageInfo').innerHTML = `<div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">ğŸ“¸ ${filename}</div>`;
                }
            } catch (error) {
                document.getElementById('imageInfo').innerHTML = `<div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">ğŸ“¸ ${filename}</div>`;
            }
        }

        function clearDatabase() {
            if (confirm('Effacer toutes les donnÃ©es?')) {
                Promise.all([
                    fetch('http://localhost:8000/api/clear', { method: 'POST' }),
                    fetch('http://localhost:8000/api/clear', { method: 'POST' })
                ]).then(() => {
                    alert('âœ… DonnÃ©es effacÃ©es');
                    loadAllStats();
                });
            }
        }

        function openOSINT(imageId, imageSrc) {
            const osintUrl = `osint.html?id=${encodeURIComponent(imageId)}&src=${encodeURIComponent(imageSrc)}`;
            window.open(osintUrl, '_blank', 'width=1400,height=900');
        }

        function openFolder() {
            window.open('file:///Users/xunit/Desktop/%F0%9F%93%81%20Projets/sar/image-search-dashboard/scraped_images/', '_blank');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
