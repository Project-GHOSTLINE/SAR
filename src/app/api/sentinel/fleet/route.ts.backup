// API: Sentinel Fleet Management
// GET /api/sentinel/fleet - Liste de tous les sentinels avec leurs specs
// POST /api/sentinel/fleet - CrÃ©er/Update un sentinel

import { NextRequest, NextResponse } from 'next/server';
import { writeFile, readFile, mkdir } from 'fs/promises';
import { join } from 'path';

const cacheDir = join(process.cwd(), '.sentinel-cache');
const fleetFile = join(cacheDir, 'fleet.json');

interface Sentinel {
  id: string;
  name: string;
  class: 'scout' | 'guardian' | 'destroyer';
  level: number;
  xp: number;
  xp_to_next: number;
  health: number;
  max_health: number;
  energy: number;
  max_energy: number;

  // Stats
  attack: number;
  defense: number;
  speed: number;
  accuracy: number;

  // Loadout
  weapon: string;
  skin: string;

  // Achievements
  missions_completed: number;
  threats_eliminated: number;
  builds_completed: number;
  tests_passed: number;

  // Power-ups
  powerups: string[];

  // Status
  status: 'idle' | 'active' | 'recharging' | 'offline';
  last_mission: string;
  created_at: string;
  updated_at: string;
}

const DEFAULT_SENTINELS: Sentinel[] = [
  {
    id: 'sentinel-001',
    name: 'Scout Alpha',
    class: 'scout',
    level: 5,
    xp: 2400,
    xp_to_next: 3000,
    health: 100,
    max_health: 100,
    energy: 80,
    max_energy: 100,
    attack: 65,
    defense: 45,
    speed: 95,
    accuracy: 88,
    weapon: 'Read',
    skin: 'ðŸ¤–',
    missions_completed: 23,
    threats_eliminated: 47,
    builds_completed: 12,
    tests_passed: 8,
    powerups: ['speed_boost', 'scanner_pro'],
    status: 'idle',
    last_mission: '2026-01-14T01:30:00Z',
    created_at: '2026-01-10T00:00:00Z',
    updated_at: '2026-01-14T02:00:00Z'
  },
  {
    id: 'sentinel-002',
    name: 'Guardian Prime',
    class: 'guardian',
    level: 7,
    xp: 4200,
    xp_to_next: 5000,
    health: 150,
    max_health: 150,
    energy: 100,
    max_energy: 100,
    attack: 75,
    defense: 95,
    speed: 60,
    accuracy: 82,
    weapon: 'Edit',
    skin: 'ðŸ¦¾',
    missions_completed: 34,
    threats_eliminated: 68,
    builds_completed: 18,
    tests_passed: 15,
    powerups: ['armor_boost', 'shield_regen', 'tactical_analysis'],
    status: 'active',
    last_mission: '2026-01-14T02:25:00Z',
    created_at: '2026-01-08T00:00:00Z',
    updated_at: '2026-01-14T02:25:00Z'
  },
  {
    id: 'sentinel-003',
    name: 'Destroyer Omega',
    class: 'destroyer',
    level: 10,
    xp: 8500,
    xp_to_next: 10000,
    health: 120,
    max_health: 180,
    energy: 90,
    max_energy: 120,
    attack: 120,
    defense: 70,
    speed: 75,
    accuracy: 95,
    weapon: 'Bash',
    skin: 'âš¡',
    missions_completed: 56,
    threats_eliminated: 142,
    builds_completed: 32,
    tests_passed: 28,
    powerups: ['damage_boost', 'critical_strike', 'aoe_blast', 'power_surge'],
    status: 'recharging',
    last_mission: '2026-01-14T02:20:00Z',
    created_at: '2026-01-05T00:00:00Z',
    updated_at: '2026-01-14T02:20:00Z'
  }
];

export async function GET(request: NextRequest) {
  try {
    let fleet: Sentinel[] = [];

    try {
      await mkdir(cacheDir, { recursive: true });
      const data = await readFile(fleetFile, 'utf-8');
      fleet = JSON.parse(data);
    } catch {
      // Initialize with defaults
      fleet = DEFAULT_SENTINELS;
      await writeFile(fleetFile, JSON.stringify(fleet, null, 2));
    }

    // Calculate power rating for each sentinel
    const fleetWithPower = fleet.map(s => ({
      ...s,
      power_rating: calculatePowerRating(s)
    }));

    return NextResponse.json({
      success: true,
      fleet: fleetWithPower,
      total: fleet.length
    });

  } catch (error: any) {
    console.error('Fleet error:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const updates = await request.json();

    await mkdir(cacheDir, { recursive: true });

    let fleet: Sentinel[] = [];
    try {
      const data = await readFile(fleetFile, 'utf-8');
      fleet = JSON.parse(data);
    } catch {
      fleet = DEFAULT_SENTINELS;
    }

    // Update sentinel
    const index = fleet.findIndex(s => s.id === updates.id);
    if (index !== -1) {
      fleet[index] = {
        ...fleet[index],
        ...updates,
        updated_at: new Date().toISOString()
      };
    } else {
      // Create new sentinel
      fleet.push({
        ...updates,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      });
    }

    await writeFile(fleetFile, JSON.stringify(fleet, null, 2));

    return NextResponse.json({
      success: true,
      sentinel: fleet[index]
    });

  } catch (error: any) {
    console.error('Update fleet error:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}

function calculatePowerRating(sentinel: Sentinel): number {
  const baseRating = (
    sentinel.attack * 0.3 +
    sentinel.defense * 0.2 +
    sentinel.speed * 0.2 +
    sentinel.accuracy * 0.15 +
    sentinel.level * 10 +
    sentinel.powerups.length * 5
  );

  return Math.round(baseRating);
}
